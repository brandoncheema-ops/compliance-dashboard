<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NF6 Capital - Tax & Annual Reports</title>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f5f7fa;
            --card: #fff;
            --border: #e2e8f0;
            --text: #1a202c;
            --text2: #64748b;
            --accent: #2563eb;
            --accent-lt: #eff6ff;
            --green: #16a34a;
            --green-bg: #f0fdf4;
            --yellow: #ca8a04;
            --yellow-bg: #fefce8;
            --red: #dc2626;
            --red-bg: #fef2f2;
            --orange: #ea580c;
            --orange-bg: #fff7ed;
            --purple: #7c3aed;
            --purple-bg: #f5f3ff;
            --nav: #0f172a;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text2: #94a3b8;
            --accent: #60a5fa;
            --accent-lt: #1e3a5f;
            --green: #4ade80;
            --green-bg: #064e3b;
            --yellow: #fbbf24;
            --yellow-bg: #713f12;
            --red: #f87171;
            --red-bg: #7f1d1d;
            --orange: #fb923c;
            --orange-bg: #7c2d12;
            --purple: #a78bfa;
            --purple-bg: #4c1d95;
            --nav: #020617;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Navigation */
        nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--nav);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .brand span {
            color: var(--accent);
            font-style: italic;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            margin-left: 3rem;
        }

        .nav-links a {
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .toggle-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .hamburger {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .nav-clocks {
            display: flex;
            gap: 1rem;
        }

        .clock-circle {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
        }

        .clock-label {
            font-weight: 600;
            color: var(--accent);
        }

        .clock-time {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        .today-badge {
            background: var(--accent);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .sign-out-btn {
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            padding: 0.5rem 1rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .sign-out-btn:hover {
            background: var(--red);
            color: white;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--text2);
            font-size: 1rem;
        }

        /* Auth Overlay */
        .auth-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 3rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .auth-card h2 {
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .auth-card p {
            color: var(--text2);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        #firebaseui-auth-container {
            display: flex;
            justify-content: center;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
        }

        .stat-change {
            font-size: 0.8rem;
            color: var(--green);
            margin-top: 0.5rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
        }

        .chart-card h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Upload Section */
        .upload-section {
            background: var(--card);
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s;
        }

        .upload-section.dragover {
            border-color: var(--accent);
            background: var(--accent-lt);
        }

        .upload-section h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }

        .upload-section p {
            color: var(--text2);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .upload-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent);
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--card);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-secondary:hover {
            background: var(--accent-lt);
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-success:hover {
            background: var(--green);
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: var(--red);
            opacity: 0.9;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* File Input */
        #csvFile, #sheetsUrl {
            display: none;
        }

        /* Data Table */
        .table-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h3 {
            font-size: 1.1rem;
            color: var(--text);
        }

        .filter-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            align-items: center;
        }

        .filter-row label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-row select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 140px;
        }

        .filter-row select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-lt);
        }

        .filter-row .clear-filters {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--card);
            color: var(--text2);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-row .clear-filters:hover {
            border-color: var(--red);
            color: var(--red);
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            min-width: 250px;
        }

        .search-bar input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
        }

        .search-bar input::placeholder {
            color: var(--text2);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-lt);
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead {
            background: var(--bg);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            user-select: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        th:hover {
            background: var(--accent-lt);
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 0.8rem;
        }

        th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        tbody tr:nth-child(even) {
            background: var(--bg);
        }

        tbody tr:hover {
            background: var(--accent-lt);
        }

        td {
            padding: 1rem;
            color: var(--text);
        }

        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: var(--green-bg);
            color: var(--green);
        }

        .status-sold {
            background: var(--orange-bg);
            color: var(--orange);
        }

        .status-dissolved {
            background: var(--red-bg);
            color: var(--red);
        }

        .status-written-off {
            background: #e5e7eb;
            color: #6b7280;
        }

        .currency {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .percentage {
            color: var(--green);
            font-weight: 600;
        }

        .percentage.negative {
            color: var(--red);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text2);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state p {
            max-width: 400px;
            line-height: 1.6;
        }

        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }

        .modal.open {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card);
            border-radius: 1rem;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: var(--accent);
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 201;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text2);
            margin-bottom: 1rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .detail-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent);
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--text);
            font-weight: 500;
            word-break: break-word;
        }

        .detail-value.currency {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.95rem;
        }

        .links-list {
            list-style: none;
            margin: 1rem 0;
        }

        .links-list li {
            margin-bottom: 0.5rem;
        }

        .links-list a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .links-list a:hover {
            text-decoration: underline;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 2rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            bottom: 0;
            z-index: 201;
        }

        .modal-footer button {
            flex: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 300;
            animation: slideInRight 0.3s;
            max-width: 400px;
        }

        .toast.success {
            background: var(--green);
        }

        .toast.error {
            background: var(--red);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Footer */
        footer {
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 1.5rem 2rem;
            text-align: center;
            color: var(--text2);
            font-size: 0.9rem;
            margin-top: 3rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .hamburger {
                display: block;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                gap: 1rem;
                width: 100%;
                margin-left: 0;
            }

            .nav-links.open {
                display: flex;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
            }

            .search-bar {
                min-width: 100%;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .modal-content {
                width: 95%;
            }

            .modal-header {
                padding: 1.5rem;
            }

            .modal-header h2 {
                font-size: 1.25rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <h2>NF6 Capital</h2>
            <p>Sign in with your nf6capital.com account to continue</p>
            <div id="firebaseui-auth-container"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;width:100%">
            <button class="hamburger" onclick="toggleMobileMenu()">‚ò∞</button>
            <a href="index.html" class="brand">NF6 <span>Capital</span></a>
            <div class="nav-links" id="mobileMenu">
                <a href="index.html">HomeBase</a>
                <a href="compliance-dashboard.html">Dashboard</a>
                <a href="compliance-calendar.html">Calendar</a>
                <a href="audit-trail.html">Audit Trail</a>
                <a href="upload.html">Upload</a>
                <a href="document-finder.html">Documents</a>
            </div>
        </div>
        <div class="nav-right">
            <button class="toggle-btn" onclick="toggleLang()">‚óè <span id="langLabel">ES</span></button>
            <button class="toggle-btn" onclick="toggleTheme()">‚òΩ Dark</button>
            <div class="nav-clocks">
                <div class="clock-circle">
                    <span class="clock-label">COL</span>
                    <span class="clock-time" id="clockCOL">--:--:--</span>
                </div>
                <div class="clock-circle">
                    <span class="clock-label">PR</span>
                    <span class="clock-time" id="clockPR">--:--:--</span>
                </div>
            </div>
            <span class="today-badge" id="todayBadge"></span>
            <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Tax & Annual Reports</h1>
            <p>Track tax filings, deadlines, and compliance status</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h3>Load Tax Data</h3>
            <p>Choose a CSV file or enter a Google Sheets URL to get started</p>
            <div class="upload-buttons">
                <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">
                    üìÅ Choose CSV File
                </button>
                <button class="btn btn-secondary" onclick="promptSheetsUrl()">
                    üîó Google Sheets URL
                </button>
                <button class="btn btn-success" onclick="exportToCSV()">
                    üìä Export CSV
                </button>
            </div>
            <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Items</div>
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-change" id="statTotalChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Due by March</div>
                <div class="stat-value" id="statMarch">0</div>
                <div class="stat-change" id="statMarchChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Due by April</div>
                <div class="stat-value" id="statApril">0</div>
                <div class="stat-change" id="statAprilChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Filed</div>
                <div class="stat-value" id="statFiled">0</div>
                <div class="stat-change" id="statFiledChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Not Started</div>
                <div class="stat-value" id="statNotStarted">0</div>
                <div class="stat-change" id="statNotStartedChange"></div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Filing Status</h3>
                <div class="chart-container">
                    <canvas id="filingStatusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Review Status</h3>
                <div class="chart-container">
                    <canvas id="reviewStatusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Items by Due Date</h3>
                <div class="chart-container">
                    <canvas id="dueDateChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Draft Status Overview</h3>
                <div class="chart-container">
                    <canvas id="draftStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="table-section">
            <div class="table-header">
                <h3>Tax Filing Portfolio</h3>
            </div>

            <!-- Filters -->
            <div class="filter-row">
                <label for="filterDueDate">Due Date:</label>
                <select id="filterDueDate" onchange="applyFilters()">
                    <option value="">All Dates</option>
                </select>

                <label for="filterFilingStatus">Filing Status:</label>
                <select id="filterFilingStatus" onchange="applyFilters()">
                    <option value="">All Status</option>
                </select>

                <label for="filterReviewStatus">Review Status:</label>
                <select id="filterReviewStatus" onchange="applyFilters()">
                    <option value="">All Status</option>
                </select>

                <label for="filterPreparedBy">Prepared By:</label>
                <select id="filterPreparedBy" onchange="applyFilters()">
                    <option value="">All People</option>
                </select>

                <button class="clear-filters" onclick="clearFilters()">Clear Filters</button>
            </div>

            <!-- Data Table -->
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('Item')">Item</th>
                            <th class="sortable" onclick="sortTable('Due date')">Due Date</th>
                            <th class="sortable" onclick="sortTable('Status update')">Status Update</th>
                            <th class="sortable" onclick="sortTable('Person to prepare')">Person to Prepare</th>
                            <th class="sortable" onclick="sortTable('State report')">State Report</th>
                            <th class="sortable" onclick="sortTable('Review status with PR')">Review Status</th>
                            <th class="sortable" onclick="sortTable('Filing status')">Filing Status</th>
                            <th class="sortable" onclick="sortTable('Confirmation numbers')">Confirmation #</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" style="text-align:center;padding:3rem;color:var(--text2);">
                                <h3>No data loaded</h3>
                                <p>Upload a CSV file or enter a Google Sheets URL to see tax filing data</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Item Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 NF6 Capital. All rights reserved. | Tax & Annual Reports Dashboard</p>
    </footer>

    <script>
        // ============================================================================
        // GLOBAL STATE & CONFIG
        // ============================================================================

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbvvj4qCzfZPdRxU6BtbRSfXDXPitNwkQ",
            authDomain: "nf6-compliance.firebaseapp.com",
            projectId: "nf6-compliance"
        };
        const ALLOWED_DOMAIN = 'nf6capital.com';

        let allData = [];
        let filteredData = [];
        let currentSort = { column: null, direction: 'asc' };
        let charts = {};

        // ============================================================================
        // UTILITY: Normalize Keys
        // ============================================================================

        function normalizeKeys(data) {
            return data.map(row => {
                const clean = {};
                Object.keys(row).forEach(k => { clean[k.trim()] = row[k]; });
                return clean;
            });
        }

        // ============================================================================
        // FIREBASE INITIALIZATION
        // ============================================================================

        try {
            firebase.initializeApp(FIREBASE_CONFIG);
        } catch (e) {
            console.warn('Firebase already initialized');
        }

        firebase.auth().onAuthStateChanged(user => {
            const authOverlay = document.getElementById('authOverlay');
            if (user) {
                authOverlay.classList.add('hidden');
                loadStoredData();
                initializePage();
            } else {
                authOverlay.classList.remove('hidden');
                initializeGoogleSignIn();
            }
        });

        function initializeGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ hd: ALLOWED_DOMAIN });

            const signInBtn = document.createElement('button');
            signInBtn.className = 'btn btn-primary';
            signInBtn.textContent = 'Sign in with Google';
            signInBtn.onclick = () => {
                firebase.auth().signInWithPopup(provider)
                    .catch(error => {
                        console.error('Auth error:', error);
                        showToast('Sign in failed. Please try again.', 'error');
                    });
            };

            const container = document.getElementById('firebaseui-auth-container');
            container.innerHTML = '';
            container.appendChild(signInBtn);
        }

        function signOut() {
            firebase.auth().signOut().catch(err => console.error(err));
        }

        // ============================================================================
        // NAVIGATION & UI
        // ============================================================================

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('open');
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        function toggleLang() {
            const label = document.getElementById('langLabel');
            const current = label.textContent.trim();
            label.textContent = current === 'ES' ? 'EN' : 'ES';
            localStorage.setItem('lang', current === 'ES' ? 'EN' : 'ES');
        }

        function initializePage() {
            // Load theme
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);

            // Load language
            const lang = localStorage.getItem('lang') || 'ES';
            document.getElementById('langLabel').textContent = lang;

            // Initialize clocks and today badge
            updateClocks();
            updateTodayBadge();
            setInterval(updateClocks, 1000);
        }

        function updateClocks() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'America/Bogota',
                hour12: false
            });
            const colTime = formatter.format(now);

            const formatterPR = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'America/Puerto_Rico',
                hour12: false
            });
            const prTime = formatterPR.format(now);

            document.getElementById('clockCOL').textContent = colTime;
            document.getElementById('clockPR').textContent = prTime;
        }

        function updateTodayBadge() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('todayBadge').textContent = dateStr;
        }

        // ============================================================================
        // DATA LOADING
        // ============================================================================

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.data && results.data.length > 0) {
                        allData = normalizeKeys(results.data);
                        localStorage.setItem('nf6_tax_data', JSON.stringify(allData));
                        filteredData = [...allData];
                        updatePageData();
                        showToast('Data loaded successfully!', 'success');
                    }
                },
                error: (error) => {
                    showToast('Error parsing CSV: ' + error.message, 'error');
                }
            });
        }

        function promptSheetsUrl() {
            const url = prompt('Enter Google Sheets CSV export URL:');
            if (!url) return;

            localStorage.setItem('nf6_sheets_url_tax', url);
            fetch(url)
                .then(response => response.text())
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.data && results.data.length > 0) {
                                allData = normalizeKeys(results.data);
                                localStorage.setItem('nf6_tax_data', JSON.stringify(allData));
                                filteredData = [...allData];
                                updatePageData();
                                showToast('Data loaded from Google Sheets!', 'success');
                            }
                        },
                        error: (error) => {
                            showToast('Error loading from Google Sheets: ' + error.message, 'error');
                        }
                    });
                })
                .catch(error => {
                    showToast('Error fetching Google Sheets: ' + error.message, 'error');
                });
        }

        function loadStoredData() {
            const stored = localStorage.getItem('nf6_tax_data');
            if (stored) {
                try {
                    allData = JSON.parse(stored);
                    filteredData = [...allData];
                } catch (e) {
                    console.error('Error loading stored data:', e);
                }
            }
        }

        function exportToCSV() {
            if (allData.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const csv = Papa.unparse(allData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'tax-reports-export.csv';
            link.click();
            window.URL.revokeObjectURL(url);
            showToast('CSV exported successfully!', 'success');
        }

        // ============================================================================
        // PAGE UPDATE & STATS
        // ============================================================================

        function updatePageData() {
            updateStats();
            updateCharts();
            updateFilters();
            applyFilters();
        }

        function updateStats() {
            const total = allData.length;
            const march = allData.filter(row => {
                const due = row['Due date'] || '';
                return due.includes('/3/') || due.includes('3/15');
            }).length;
            const april = allData.filter(row => {
                const due = row['Due date'] || '';
                return due.includes('/4/') || due.includes('4/15');
            }).length;
            const filed = allData.filter(row => {
                const status = (row['Filing status'] || '').toLowerCase();
                const confirmations = row['Confirmation numbers'] || '';
                return status.includes('filed') || status.includes('complete') || confirmations.trim() !== '';
            }).length;
            const notStarted = allData.filter(row => {
                const status = (row['Filing status'] || '').toLowerCase();
                return status.includes('not started') || status === '';
            }).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statMarch').textContent = march;
            document.getElementById('statApril').textContent = april;
            document.getElementById('statFiled').textContent = filed;
            document.getElementById('statNotStarted').textContent = notStarted;
        }

        // ============================================================================
        // CHARTS
        // ============================================================================

        function updateCharts() {
            updateFilingStatusChart();
            updateReviewStatusChart();
            updateDueDateChart();
            updateDraftStatusChart();
        }

        function updateFilingStatusChart() {
            const statusCounts = {};
            allData.forEach(row => {
                const status = (row['Filing status'] || '').trim() || 'Not Started';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const ctx = document.getElementById('filingStatusChart').getContext('2d');
            if (charts.filingStatus) charts.filingStatus.destroy();

            charts.filingStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#16a34a', '#fbbf24', '#f87171', '#94a3b8', '#60a5fa'
                        ],
                        borderColor: 'var(--card)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function updateReviewStatusChart() {
            const reviewCounts = {};
            allData.forEach(row => {
                const status = (row['Review status with PR'] || '').trim() || 'Not Started';
                reviewCounts[status] = (reviewCounts[status] || 0) + 1;
            });

            const ctx = document.getElementById('reviewStatusChart').getContext('2d');
            if (charts.reviewStatus) charts.reviewStatus.destroy();

            charts.reviewStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(reviewCounts),
                    datasets: [{
                        data: Object.values(reviewCounts),
                        backgroundColor: [
                            '#16a34a', '#fbbf24', '#f87171', '#94a3b8', '#60a5fa'
                        ],
                        borderColor: 'var(--card)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function updateDueDateChart() {
            const dueDateCounts = {};
            allData.forEach(row => {
                const date = (row['Due date'] || '').trim() || 'Unknown';
                dueDateCounts[date] = (dueDateCounts[date] || 0) + 1;
            });

            const ctx = document.getElementById('dueDateChart').getContext('2d');
            if (charts.dueDate) charts.dueDate.destroy();

            charts.dueDate = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dueDateCounts),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(dueDateCounts),
                        backgroundColor: '#2563eb',
                        borderColor: '#1e40af',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateDraftStatusChart() {
            const draftCounts = {};
            allData.forEach(row => {
                const status = (row['Draft status for bal to review'] || '').trim() || 'Not Started';
                draftCounts[status] = (draftCounts[status] || 0) + 1;
            });

            const ctx = document.getElementById('draftStatusChart').getContext('2d');
            if (charts.draftStatus) charts.draftStatus.destroy();

            charts.draftStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(draftCounts),
                    datasets: [{
                        data: Object.values(draftCounts),
                        backgroundColor: [
                            '#16a34a', '#fbbf24', '#f87171', '#94a3b8', '#60a5fa'
                        ],
                        borderColor: 'var(--card)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // ============================================================================
        // FILTERS
        // ============================================================================

        function updateFilters() {
            const dueDates = new Set();
            const filingStatuses = new Set();
            const reviewStatuses = new Set();
            const people = new Set();

            allData.forEach(row => {
                if (row['Due date']) dueDates.add(row['Due date'].trim());
                const fs = (row['Filing status'] || '').trim() || 'Not Started';
                if (fs) filingStatuses.add(fs);
                const rs = (row['Review status with PR'] || '').trim() || 'Not Started';
                if (rs) reviewStatuses.add(rs);
                if (row['Person to prepare']) people.add(row['Person to prepare'].trim());
            });

            populateSelect('filterDueDate', Array.from(dueDates).sort());
            populateSelect('filterFilingStatus', Array.from(filingStatuses).sort());
            populateSelect('filterReviewStatus', Array.from(reviewStatuses).sort());
            populateSelect('filterPreparedBy', Array.from(people).sort());
        }

        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            const currentValue = select.value;
            select.innerHTML = '<option value="">All</option>';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        function applyFilters() {
            const dueDateFilter = document.getElementById('filterDueDate').value;
            const filingStatusFilter = document.getElementById('filterFilingStatus').value;
            const reviewStatusFilter = document.getElementById('filterReviewStatus').value;
            const preparedByFilter = document.getElementById('filterPreparedBy').value;

            filteredData = allData.filter(row => {
                if (dueDateFilter && row['Due date'] !== dueDateFilter) return false;
                if (filingStatusFilter && row['Filing status'] !== filingStatusFilter) return false;
                if (reviewStatusFilter && row['Review status with PR'] !== reviewStatusFilter) return false;
                if (preparedByFilter && row['Person to prepare'] !== preparedByFilter) return false;
                return true;
            });

            renderTable();
        }

        function clearFilters() {
            document.getElementById('filterDueDate').value = '';
            document.getElementById('filterFilingStatus').value = '';
            document.getElementById('filterReviewStatus').value = '';
            document.getElementById('filterPreparedBy').value = '';
            filteredData = [...allData];
            renderTable();
        }

        // ============================================================================
        // TABLE RENDERING & SORTING
        // ============================================================================

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--text2);"><h3>No data</h3><p>No items match the current filters</p></td></tr>';
                return;
            }

            tbody.innerHTML = filteredData.map((row, idx) => `
                <tr onclick="openDetailModal(${allData.indexOf(row)})">
                    <td>${row['Item'] || ''}</td>
                    <td>${row['Due date'] || ''}</td>
                    <td>${getStatusBadge(row['Status update'])}</td>
                    <td>${row['Person to prepare'] || ''}</td>
                    <td>${row['State report'] || ''}</td>
                    <td>${getStatusBadge(row['Review status with PR'])}</td>
                    <td>${getStatusBadge(row['Filing status'])}</td>
                    <td>${row['Confirmation numbers'] || ''}</td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            if (!status) status = 'Not Started';
            const lower = status.toLowerCase();

            let className = 'status-written-off';
            if (lower.includes('filed') || lower.includes('complete') || lower.includes('approved')) {
                className = 'status-active';
            } else if (lower.includes('waiting') || lower.includes('pending') || lower.includes('draft') || lower.includes('progress') || lower.includes('review')) {
                className = 'status-sold';
            } else if (lower.includes('not started')) {
                className = 'status-written-off';
            }

            return `<span class="status-badge ${className}">${status}</span>`;
        }

        function sortTable(column) {
            const th = event.target;
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            document.querySelectorAll('th').forEach(t => {
                t.classList.remove('sorted-asc', 'sorted-desc');
            });
            th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                if (currentSort.direction === 'asc') {
                    return aVal.toString().localeCompare(bVal.toString());
                } else {
                    return bVal.toString().localeCompare(aVal.toString());
                }
            });

            renderTable();
        }

        // ============================================================================
        // MODAL
        // ============================================================================

        function openDetailModal(index) {
            const row = allData[index];
            const modal = document.getElementById('detailModal');
            document.getElementById('modalTitle').textContent = row['Item'] || 'Item Details';

            const fields = [
                'Item', 'Due date', 'Extension file date', 'Have ready for review due date',
                'Status update', 'Person to prepare', 'State report', 'Review date with Bal',
                'Draft status for bal to review', 'Date sent to PR Team', 'File date',
                'Review With Bal', 'Review status with PR', 'Filing status', 'Confirmation numbers', 'Links'
            ];

            const detailsHtml = fields.map(field => `
                <div class="detail-item">
                    <div class="detail-label">${field}</div>
                    <div class="detail-value">${row[field] || 'N/A'}</div>
                </div>
            `).join('');

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-section">
                    <h3>Item Information</h3>
                    <div class="detail-grid">
                        ${detailsHtml}
                    </div>
                </div>
            `;

            modal.classList.add('open');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('open');
        }

        // ============================================================================
        // TOAST
        // ============================================================================

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
