<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NF6 Capital - Tax & Annual Reports</title>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f5f7fa;
            --card: #fff;
            --border: #e2e8f0;
            --text: #1a202c;
            --text2: #64748b;
            --accent: #2563eb;
            --accent-lt: #eff6ff;
            --green: #16a34a;
            --green-bg: #f0fdf4;
            --yellow: #ca8a04;
            --yellow-bg: #fefce8;
            --red: #dc2626;
            --red-bg: #fef2f2;
            --orange: #ea580c;
            --orange-bg: #fff7ed;
            --purple: #7c3aed;
            --purple-bg: #f5f3ff;
            --nav: #0f172a;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text2: #94a3b8;
            --accent: #60a5fa;
            --accent-lt: #1e3a5f;
            --green: #4ade80;
            --green-bg: #064e3b;
            --yellow: #fbbf24;
            --yellow-bg: #713f12;
            --red: #f87171;
            --red-bg: #7f1d1d;
            --orange: #fb923c;
            --orange-bg: #7c2d12;
            --purple: #a78bfa;
            --purple-bg: #4c1d95;
            --nav: #020617;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Navigation */
        nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--nav);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .brand span {
            color: var(--accent);
            font-style: italic;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            margin-left: 3rem;
        }

        .nav-links a {
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .toggle-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .hamburger {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .nav-clocks {
            display: flex;
            gap: 1rem;
        }

        .clock-circle {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
        }

        .clock-label {
            font-weight: 600;
            color: var(--accent);
        }

        .clock-time {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        .today-badge {
            background: var(--accent);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .sign-out-btn {
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            padding: 0.5rem 1rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .sign-out-btn:hover {
            background: var(--red);
            color: white;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--text2);
            font-size: 1rem;
        }

        /* Auth Overlay */
        .auth-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 3rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .auth-card h2 {
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .auth-card p {
            color: var(--text2);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        #firebaseui-auth-container {
            display: flex;
            justify-content: center;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
        }

        .stat-change {
            font-size: 0.8rem;
            color: var(--green);
            margin-top: 0.5rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
        }

        .chart-card h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Upload Section */
        .upload-section {
            background: var(--card);
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s;
        }

        .upload-section.dragover {
            border-color: var(--accent);
            background: var(--accent-lt);
        }

        .upload-section h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }

        .upload-section p {
            color: var(--text2);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .upload-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent);
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--card);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-secondary:hover {
            background: var(--accent-lt);
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-success:hover {
            background: var(--green);
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: var(--red);
            opacity: 0.9;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* File Input */
        #csvFileTax, #sheetsUrlTax, #csvFileAnnual, #sheetsUrlAnnual {
            display: none;
        }

        /* Data Table */
        .table-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h3 {
            font-size: 1.1rem;
            color: var(--text);
        }

        .filter-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            align-items: center;
        }

        .filter-row label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-row select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 140px;
        }

        .filter-row select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-lt);
        }

        .filter-row .clear-filters {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--card);
            color: var(--text2);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-row .clear-filters:hover {
            border-color: var(--red);
            color: var(--red);
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            min-width: 250px;
        }

        .search-bar input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
        }

        .search-bar input::placeholder {
            color: var(--text2);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-lt);
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead {
            background: var(--bg);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            user-select: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        th:hover {
            background: var(--accent-lt);
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 0.8rem;
        }

        th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        tbody tr:nth-child(even) {
            background: var(--bg);
        }

        tbody tr:hover {
            background: var(--accent-lt);
        }

        td {
            padding: 1rem;
            color: var(--text);
        }

        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: var(--green-bg);
            color: var(--green);
        }

        .status-sold {
            background: var(--orange-bg);
            color: var(--orange);
        }

        .status-dissolved {
            background: var(--red-bg);
            color: var(--red);
        }

        .status-written-off {
            background: #e5e7eb;
            color: #6b7280;
        }

        .currency {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .percentage {
            color: var(--green);
            font-weight: 600;
        }

        .percentage.negative {
            color: var(--red);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text2);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state p {
            max-width: 400px;
            line-height: 1.6;
        }

        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }

        .modal.open {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card);
            border-radius: 1rem;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: var(--accent);
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 201;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text2);
            margin-bottom: 1rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .detail-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent);
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--text);
            font-weight: 500;
            word-break: break-word;
        }

        .detail-value.currency {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.95rem;
        }

        .links-list {
            list-style: none;
            margin: 1rem 0;
        }

        .links-list li {
            margin-bottom: 0.5rem;
        }

        .links-list a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .links-list a:hover {
            text-decoration: underline;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 2rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            bottom: 0;
            z-index: 201;
        }

        .modal-footer button {
            flex: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 300;
            animation: slideInRight 0.3s;
            max-width: 400px;
        }

        .toast.success {
            background: var(--green);
        }

        .toast.error {
            background: var(--red);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Footer */
        footer {
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 1.5rem 2rem;
            text-align: center;
            color: var(--text2);
            font-size: 0.9rem;
            margin-top: 3rem;
        }

        /* TAB STYLES */
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 1rem 2rem;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text2);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-btn:hover {
            color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .hamburger {
                display: block;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                gap: 1rem;
                width: 100%;
                margin-left: 0;
            }

            .nav-links.open {
                display: flex;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
            }

            .search-bar {
                min-width: 100%;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .modal-content {
                width: 95%;
            }

            .modal-header {
                padding: 1.5rem;
            }

            .modal-header h2 {
                font-size: 1.25rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <h2>NF6 Capital</h2>
            <p>Sign in with your nf6capital.com account to continue</p>
            <div id="firebaseui-auth-container"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;width:100%">
            <button class="hamburger" onclick="toggleMobileMenu()">‚ò∞</button>
            <a href="index.html" class="brand">NF6 <span>Capital</span></a>
            <div class="nav-links" id="mobileMenu">
                <a href="index.html">HomeBase</a>
                <a href="compliance-dashboard.html">Dashboard</a>
                <a href="compliance-calendar.html">Calendar</a>
                <a href="audit-trail.html">Audit Trail</a>
                <a href="upload.html">Upload</a>
                <a href="document-finder.html">Documents</a>
            </div>
        </div>
        <div class="nav-right">
            <button class="toggle-btn" onclick="toggleLang()">‚óè <span id="langLabel">ES</span></button>
            <button class="toggle-btn" onclick="toggleTheme()">‚òΩ Dark</button>
            <div class="nav-clocks">
                <div class="clock-circle">
                    <span class="clock-label">COL</span>
                    <span class="clock-time" id="clockCOL">--:--:--</span>
                </div>
                <div class="clock-circle">
                    <span class="clock-label">PR</span>
                    <span class="clock-time" id="clockPR">--:--:--</span>
                </div>
            </div>
            <span class="today-badge" id="todayBadge"></span>
            <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Tax & Annual Reports</h1>
            <p>Track tax filings, deadlines, and compliance status</p>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('tax')">Tax Tracking</button>
            <button class="tab-btn" onclick="switchTab('annual')">Annual Reports</button>
        </div>

        <!-- TAB 1: TAX TRACKING -->
        <div class="tab-content active" id="taxContent">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSectionTax" ondrop="handleDropTax(event)" ondragover="handleDragOverTax(event)" ondragleave="handleDragLeaveTax(event)">
                <h3>üìä Upload Tax Data or Sync from Google Sheets</h3>
                <p>Drag and drop a CSV file, or choose from the options below</p>
                <div class="upload-buttons">
                    <button class="btn btn-primary" onclick="document.getElementById('csvFileTax').click()">üìÅ Choose CSV File</button>
                    <input type="file" id="csvFileTax" accept=".csv" onchange="handleFileSelectTax(event)">
                    <button class="btn btn-secondary" onclick="showSheetsDialogTax()">üìä Google Sheets URL</button>
                    <button class="btn btn-secondary" onclick="exportCSVTax()">üíæ Export CSV</button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGridTax" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value" id="statTotalItemsTax">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Due by March</div>
                    <div class="stat-value" id="statDueMarchTax">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Due by April</div>
                    <div class="stat-value" id="statDueAprilTax">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Filed</div>
                    <div class="stat-value" id="statFiledTax">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Not Started</div>
                    <div class="stat-value" id="statNotStartedTax">0</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid" id="chartsGridTax" style="display: none;">
                <div class="chart-card">
                    <h3>Filing Status</h3>
                    <div class="chart-container">
                        <canvas id="filingStatusChartTax"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Review Status</h3>
                    <div class="chart-container">
                        <canvas id="reviewStatusChartTax"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Items by Due Date</h3>
                    <div class="chart-container">
                        <canvas id="dueDateChartTax"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Draft Status</h3>
                    <div class="chart-container">
                        <canvas id="draftStatusChartTax"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table Section -->
            <div class="table-section" id="tableSectionTax" style="display: none;">
                <div class="table-header">
                    <h3>Tax Items</h3>
                    <div class="search-bar">
                        <input type="text" id="searchInputTax" placeholder="Search tax items..." onkeyup="applyFiltersTax()">
                    </div>
                </div>
                <div class="filter-row" id="filterRowTax">
                    <label>Filters:</label>
                    <select id="filterDueDateTax" onchange="applyFiltersTax()">
                        <option value="">All Due Dates</option>
                    </select>
                    <select id="filterFilingStatusTax" onchange="applyFiltersTax()">
                        <option value="">All Filing Status</option>
                    </select>
                    <select id="filterReviewStatusTax" onchange="applyFiltersTax()">
                        <option value="">All Review Status</option>
                    </select>
                    <select id="filterPersonTax" onchange="applyFiltersTax()">
                        <option value="">All Persons</option>
                    </select>
                    <button class="clear-filters" onclick="clearFiltersTax()">Clear Filters</button>
                </div>
                <div class="table-wrapper">
                    <table id="dataTableTax">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTableTax('Item')">Item</th>
                                <th class="sortable" onclick="sortTableTax('Due date')">Due Date</th>
                                <th>Status Update</th>
                                <th class="sortable" onclick="sortTableTax('Person to prepare')">Person to Prepare</th>
                                <th class="sortable" onclick="sortTableTax('State report')">State Report</th>
                                <th class="sortable" onclick="sortTableTax('Review status with PR')">Review Status</th>
                                <th class="sortable" onclick="sortTableTax('Filing status')">Filing Status</th>
                                <th>Confirmation Numbers</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyTax">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyStateTax">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="30" r="20" fill="currentColor"/>
                    <path d="M 20 60 Q 20 70 30 75 L 70 75 Q 80 70 80 60" fill="currentColor"/>
                </svg>
                <h3>No Tax Data Yet</h3>
                <p>Upload a CSV file or sync from Google Sheets to get started with your tax tracking</p>
            </div>
        </div>

        <!-- TAB 2: ANNUAL REPORTS -->
        <div class="tab-content" id="annualContent">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSectionAnnual" ondrop="handleDropAnnual(event)" ondragover="handleDragOverAnnual(event)" ondragleave="handleDragLeaveAnnual(event)">
                <h3>üìä Upload Annual Reports or Sync from Google Sheets</h3>
                <p>Drag and drop a CSV file, or choose from the options below</p>
                <div class="upload-buttons">
                    <button class="btn btn-primary" onclick="document.getElementById('csvFileAnnual').click()">üìÅ Choose CSV File</button>
                    <input type="file" id="csvFileAnnual" accept=".csv" onchange="handleFileSelectAnnual(event)">
                    <button class="btn btn-secondary" onclick="showSheetsDialogAnnual()">üìä Google Sheets URL</button>
                    <button class="btn btn-secondary" onclick="exportCSVAnnual()">üíæ Export CSV</button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGridAnnual" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Total Entities</div>
                    <div class="stat-value" id="statTotalEntitiesAnnual">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Paid/Complete</div>
                    <div class="stat-value" id="statPaidAnnual">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Not Started</div>
                    <div class="stat-value" id="statNotStartedAnnual">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">N/A Entities</div>
                    <div class="stat-value" id="statNAAnnual">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Tax Due</div>
                    <div class="stat-value" id="statTotalTaxAnnual">$0</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid" id="chartsGridAnnual" style="display: none;">
                <div class="chart-card">
                    <h3>Filing Status</h3>
                    <div class="chart-container">
                        <canvas id="filingStatusChartAnnual"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Entities by State</h3>
                    <div class="chart-container">
                        <canvas id="stateChartAnnual"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Entity Types</h3>
                    <div class="chart-container">
                        <canvas id="entityTypeChartAnnual"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Historical Filing Compliance</h3>
                    <div class="chart-container">
                        <canvas id="complianceChartAnnual"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table Section -->
            <div class="table-section" id="tableSectionAnnual" style="display: none;">
                <div class="table-header">
                    <h3>Annual Entities</h3>
                    <div class="search-bar">
                        <input type="text" id="searchInputAnnual" placeholder="Search entities..." onkeyup="applyFiltersAnnual()">
                    </div>
                </div>
                <div class="filter-row" id="filterRowAnnual">
                    <label>Filters:</label>
                    <select id="filterStatusAnnual" onchange="applyFiltersAnnual()">
                        <option value="">All Statuses</option>
                    </select>
                    <select id="filterStateAnnual" onchange="applyFiltersAnnual()">
                        <option value="">All States</option>
                    </select>
                    <select id="filterEntityTypeAnnual" onchange="applyFiltersAnnual()">
                        <option value="">All Entity Types</option>
                    </select>
                    <select id="filterPersonResponsibleAnnual" onchange="applyFiltersAnnual()">
                        <option value="">All Persons</option>
                    </select>
                    <button class="clear-filters" onclick="clearFiltersAnnual()">Clear Filters</button>
                </div>
                <div class="table-wrapper">
                    <table id="dataTableAnnual">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTableAnnual('Entity Name')">Entity Name</th>
                                <th class="sortable" onclick="sortTableAnnual('Current Status')">Current Status</th>
                                <th class="sortable" onclick="sortTableAnnual('State of formation')">State</th>
                                <th class="sortable" onclick="sortTableAnnual('Due Date')">Due Date</th>
                                <th>Tax Amount Due</th>
                                <th class="sortable" onclick="sortTableAnnual('Last Filed date')">Last Filed</th>
                                <th class="sortable" onclick="sortTableAnnual('Entity Type')">Entity Type</th>
                                <th class="sortable" onclick="sortTableAnnual('EIN (Federal ID)')">EIN</th>
                                <th class="sortable" onclick="sortTableAnnual('Person Responsible for filing')">Person Responsible</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyAnnual">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyStateAnnual">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="30" r="20" fill="currentColor"/>
                    <path d="M 20 60 Q 20 70 30 75 L 70 75 Q 80 70 80 60" fill="currentColor"/>
                </svg>
                <h3>No Annual Report Data Yet</h3>
                <p>Upload a CSV file or sync from Google Sheets to get started with your annual reports</p>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>NF6 Capital Tax & Annual Reports | Last updated: <span id="lastUpdated">Never</span></p>
    </footer>

    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbvvj4qCzfZPdRxU6BtbRSfXDXPitNwkQ",
            authDomain: "nf6-compliance.firebaseapp.com",
            projectId: "nf6-compliance"
        };
        const ALLOWED_DOMAIN = 'nf6capital.com';
        const STORAGE_KEY_TAX = 'nf6_tax_data';
        const SHEETS_KEY_TAX = 'nf6_sheets_url_tax';
        const STORAGE_KEY_ANNUAL = 'nf6_annual_data';
        const SHEETS_KEY_ANNUAL = 'nf6_sheets_url_annual';

        let taxData = [];
        let annualData = [];
        let filteredDataTax = [];
        let filteredDataAnnual = [];
        let sortColumnTax = 'Item';
        let sortDirectionTax = 'asc';
        let sortColumnAnnual = 'Entity Name';
        let sortDirectionAnnual = 'asc';
        let chartsTax = {};
        let chartsAnnual = {};
        let currentUser = null;
        let currentLang = 'EN';

        function normalizeKeys(data) {
            return data.map(row => {
                const clean = {};
                Object.keys(row).forEach(k => { clean[k.trim()] = row[k]; });
                return clean;
            });
        }

        try {
            firebase.initializeApp(FIREBASE_CONFIG);
        } catch (error) {
            console.log('Firebase already initialized');
        }

        const auth = firebase.auth();

        function initAuth() {
            auth.onAuthStateChanged((user) => {
                if (user && user.email && user.email.endsWith('@' + ALLOWED_DOMAIN)) {
                    currentUser = user;
                    document.getElementById('authOverlay').classList.add('hidden');
                    initApp();
                } else if (user) {
                    signOut();
                    showToast('Error: Please sign in with an ' + ALLOWED_DOMAIN + ' account', 'error');
                } else {
                    document.getElementById('authOverlay').classList.remove('hidden');
                    showGoogleSignIn();
                }
            });
        }

        function showGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ hd: ALLOWED_DOMAIN });

            const signInBtn = document.createElement('button');
            signInBtn.className = 'btn btn-primary';
            signInBtn.textContent = 'Sign In with Google';
            signInBtn.onclick = () => {
                auth.signInWithPopup(provider).catch(error => {
                    showToast('Authentication failed: ' + error.message, 'error');
                });
            };

            const container = document.getElementById('firebaseui-auth-container');
            container.innerHTML = '';
            container.appendChild(signInBtn);
        }

        function signOut() {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('authOverlay').classList.remove('hidden');
            });
        }

        function initApp() {
            loadDataTax();
            loadDataAnnual();
            initClocks();
            initTheme();
            initLanguage();
            loadSheetsUrlIfExistsTax();
            loadSheetsUrlIfExistsAnnual();
        }

        function loadDataTax() {
            const stored = localStorage.getItem(STORAGE_KEY_TAX);
            if (stored) {
                try {
                    taxData = normalizeKeys(JSON.parse(stored));
                    renderDashboardTax();
                } catch (error) {
                    console.error('Error loading tax data:', error);
                    showToast('Error loading saved tax data', 'error');
                }
            }
        }

        function loadDataAnnual() {
            const stored = localStorage.getItem(STORAGE_KEY_ANNUAL);
            if (stored) {
                try {
                    annualData = normalizeKeys(JSON.parse(stored));
                    renderDashboardAnnual();
                } catch (error) {
                    console.error('Error loading annual data:', error);
                    showToast('Error loading saved annual data', 'error');
                }
            }
        }

        function handleFileSelectTax(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.data && results.data.length > 0) {
                        taxData = normalizeKeys(results.data);
                        saveDataTax();
                        renderDashboardTax();
                        showToast(`Loaded ${taxData.length} tax items successfully`, 'success');
                    } else {
                        showToast('CSV file is empty', 'error');
                    }
                },
                error: (error) => {
                    showToast('Error parsing CSV: ' + error.message, 'error');
                }
            });

            event.target.value = '';
        }

        function handleDropTax(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadSectionTax').classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0 && (files[0].type === 'text/csv' || files[0].name.endsWith('.csv'))) {
                const file = files[0];
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.data && results.data.length > 0) {
                            taxData = normalizeKeys(results.data);
                            saveDataTax();
                            renderDashboardTax();
                            showToast(`Loaded ${taxData.length} tax items successfully`, 'success');
                        }
                    },
                    error: (error) => {
                        showToast('Error parsing CSV: ' + error.message, 'error');
                    }
                });
            } else {
                showToast('Please drop a CSV file', 'error');
            }
        }

        function handleDragOverTax(event) {
            event.preventDefault();
            document.getElementById('uploadSectionTax').classList.add('dragover');
        }

        function handleDragLeaveTax(event) {
            if (event.target.id === 'uploadSectionTax') {
                document.getElementById('uploadSectionTax').classList.remove('dragover');
            }
        }

        function handleFileSelectAnnual(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.data && results.data.length > 0) {
                        annualData = normalizeKeys(results.data);
                        saveDataAnnual();
                        renderDashboardAnnual();
                        showToast(`Loaded ${annualData.length} annual entities successfully`, 'success');
                    } else {
                        showToast('CSV file is empty', 'error');
                    }
                },
                error: (error) => {
                    showToast('Error parsing CSV: ' + error.message, 'error');
                }
            });

            event.target.value = '';
        }

        function handleDropAnnual(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadSectionAnnual').classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0 && (files[0].type === 'text/csv' || files[0].name.endsWith('.csv'))) {
                const file = files[0];
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.data && results.data.length > 0) {
                            annualData = normalizeKeys(results.data);
                            saveDataAnnual();
                            renderDashboardAnnual();
                            showToast(`Loaded ${annualData.length} annual entities successfully`, 'success');
                        }
                    },
                    error: (error) => {
                        showToast('Error parsing CSV: ' + error.message, 'error');
                    }
                });
            } else {
                showToast('Please drop a CSV file', 'error');
            }
        }

        function handleDragOverAnnual(event) {
            event.preventDefault();
            document.getElementById('uploadSectionAnnual').classList.add('dragover');
        }

        function handleDragLeaveAnnual(event) {
            if (event.target.id === 'uploadSectionAnnual') {
                document.getElementById('uploadSectionAnnual').classList.remove('dragover');
            }
        }

        function showSheetsDialogTax() {
            const url = prompt('Enter Google Sheets CSV export URL (https://docs.google.com/spreadsheets/d/...export?format=csv)');
            if (url) {
                localStorage.setItem(SHEETS_KEY_TAX, url);
                loadFromSheetsTax(url);
            }
        }

        function loadFromSheetsTax(url) {
            fetch(url)
                .then(response => response.text())
                .then(csv => {
                    Papa.parse(csv, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.data && results.data.length > 0) {
                                taxData = normalizeKeys(results.data);
                                saveDataTax();
                                renderDashboardTax();
                                showToast(`Synced ${taxData.length} tax items from Google Sheets`, 'success');
                                updateLastUpdated();
                            }
                        },
                        error: (error) => {
                            showToast('Error parsing Google Sheets: ' + error.message, 'error');
                        }
                    });
                })
                .catch(error => {
                    showToast('Error fetching Google Sheets: ' + error.message, 'error');
                });
        }

        function loadSheetsUrlIfExistsTax() {
            const url = localStorage.getItem(SHEETS_KEY_TAX);
            if (url) {
                loadFromSheetsTax(url);
            }
        }

        function showSheetsDialogAnnual() {
            const url = prompt('Enter Google Sheets CSV export URL (https://docs.google.com/spreadsheets/d/...export?format=csv)');
            if (url) {
                localStorage.setItem(SHEETS_KEY_ANNUAL, url);
                loadFromSheetsAnnual(url);
            }
        }

        function loadFromSheetsAnnual(url) {
            fetch(url)
                .then(response => response.text())
                .then(csv => {
                    Papa.parse(csv, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.data && results.data.length > 0) {
                                annualData = normalizeKeys(results.data);
                                saveDataAnnual();
                                renderDashboardAnnual();
                                showToast(`Synced ${annualData.length} annual entities from Google Sheets`, 'success');
                                updateLastUpdated();
                            }
                        },
                        error: (error) => {
                            showToast('Error parsing Google Sheets: ' + error.message, 'error');
                        }
                    });
                })
                .catch(error => {
                    showToast('Error fetching Google Sheets: ' + error.message, 'error');
                });
        }

        function loadSheetsUrlIfExistsAnnual() {
            const url = localStorage.getItem(SHEETS_KEY_ANNUAL);
            if (url) {
                loadFromSheetsAnnual(url);
            }
        }

        function saveDataTax() {
            try {
                localStorage.setItem(STORAGE_KEY_TAX, JSON.stringify(taxData));
                updateLastUpdated();
            } catch (error) {
                console.error('Error saving tax data:', error);
                showToast('Error saving tax data', 'error');
            }
        }

        function saveDataAnnual() {
            try {
                localStorage.setItem(STORAGE_KEY_ANNUAL, JSON.stringify(annualData));
                updateLastUpdated();
            } catch (error) {
                console.error('Error saving annual data:', error);
                showToast('Error saving annual data', 'error');
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleString();
        }

        function parseCurrency(value) {
            if (!value || value === 'N/A' || value === '#VALUE!' || value === '') return 0;
            if (typeof value === 'string' && value.includes('%')) return 0;
            if (typeof value === 'string') {
                value = value.replace(/[$,]/g, '');
                if (value.includes('(') && value.includes(')')) {
                    value = '-' + value.replace(/[()]/g, '');
                }
                const num = parseFloat(value);
                return isNaN(num) ? 0 : num;
            }
            return typeof value === 'number' ? value : 0;
        }

        function formatCurrency(value) {
            const num = parseCurrency(value);
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(num);
        }

        function renderDashboardTax() {
            if (taxData.length === 0) {
                document.getElementById('emptyStateTax').style.display = 'flex';
                document.getElementById('statsGridTax').style.display = 'none';
                document.getElementById('chartsGridTax').style.display = 'none';
                document.getElementById('tableSectionTax').style.display = 'none';
                document.getElementById('uploadSectionTax').style.display = 'block';
                return;
            }

            document.getElementById('emptyStateTax').style.display = 'none';
            document.getElementById('statsGridTax').style.display = 'grid';
            document.getElementById('chartsGridTax').style.display = 'grid';
            document.getElementById('tableSectionTax').style.display = 'block';
            document.getElementById('uploadSectionTax').style.display = 'block';

            renderStatsTax();
            renderChartsTax();
            populateFiltersTax();
            renderTableTax();
        }

        function renderStatsTax() {
            const totalItems = taxData.length;
            const dueByMarch = taxData.filter(row => (row['Due date'] || '').includes('3/')).length;
            const dueByApril = taxData.filter(row => (row['Due date'] || '').includes('4/')).length;
            const filed = taxData.filter(row => {
                const status = (row['Filing status'] || '').toLowerCase();
                const hasConfirm = row['Confirmation numbers'] && row['Confirmation numbers'].trim() !== '';
                return status.includes('filed') || status.includes('complete') || hasConfirm;
            }).length;
            const notStarted = taxData.filter(row => {
                const status = (row['Filing status'] || '').toLowerCase();
                return status === '' || status.includes('not started');
            }).length;

            document.getElementById('statTotalItemsTax').textContent = totalItems;
            document.getElementById('statDueMarchTax').textContent = dueByMarch;
            document.getElementById('statDueAprilTax').textContent = dueByApril;
            document.getElementById('statFiledTax').textContent = filed;
            document.getElementById('statNotStartedTax').textContent = notStarted;
        }

        function renderChartsTax() {
            destroyChartsTax();

            const filingStatusCounts = {};
            taxData.forEach(row => {
                let status = (row['Filing status'] || '').trim();
                if (!status) status = 'Not Started';
                filingStatusCounts[status] = (filingStatusCounts[status] || 0) + 1;
            });

            const filingStatusColors = {
                'Not Started': '#6b7280',
                'filed': '#16a34a',
                'complete': '#16a34a'
            };

            chartsTax.filingStatusChart = new Chart(document.getElementById('filingStatusChartTax'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(filingStatusCounts),
                    datasets: [{
                        data: Object.values(filingStatusCounts),
                        backgroundColor: Object.keys(filingStatusCounts).map(status => filingStatusColors[status] || '#2563eb'),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    }
                }
            });

            const reviewStatusCounts = {};
            taxData.forEach(row => {
                let status = (row['Review status with PR'] || '').trim();
                if (!status) status = 'Not Started';
                reviewStatusCounts[status] = (reviewStatusCounts[status] || 0) + 1;
            });

            chartsTax.reviewStatusChart = new Chart(document.getElementById('reviewStatusChartTax'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(reviewStatusCounts),
                    datasets: [{
                        data: Object.values(reviewStatusCounts),
                        backgroundColor: Object.keys(reviewStatusCounts).map(status => status === 'Not Started' ? '#6b7280' : '#2563eb'),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    }
                }
            });

            const dueDateCounts = {};
            taxData.forEach(row => {
                const date = (row['Due date'] || 'Unknown').trim();
                dueDateCounts[date] = (dueDateCounts[date] || 0) + 1;
            });

            const sortedDueDates = Object.entries(dueDateCounts)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .slice(0, 15);

            chartsTax.dueDateChart = new Chart(document.getElementById('dueDateChartTax'), {
                type: 'bar',
                data: {
                    labels: sortedDueDates.map(d => d[0]),
                    datasets: [{
                        label: 'Items',
                        data: sortedDueDates.map(d => d[1]),
                        backgroundColor: '#2563eb',
                        borderColor: '#1e40af',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text2') }
                        },
                        y: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text2') }
                        }
                    }
                }
            });

            const draftStatusCounts = {};
            taxData.forEach(row => {
                let status = (row['Draft status for bal to review'] || '').trim();
                if (!status) status = 'Not Started';
                draftStatusCounts[status] = (draftStatusCounts[status] || 0) + 1;
            });

            chartsTax.draftStatusChart = new Chart(document.getElementById('draftStatusChartTax'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(draftStatusCounts),
                    datasets: [{
                        data: Object.values(draftStatusCounts),
                        backgroundColor: Object.keys(draftStatusCounts).map(status => status === 'Not Started' ? '#6b7280' : '#8b5cf6'),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    }
                }
            });
        }

        function destroyChartsTax() {
            Object.values(chartsTax).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartsTax = {};
        }

        function populateFiltersTax() {
            const dueDates = [...new Set(taxData.map(r => (r['Due date'] || '').trim()).filter(Boolean))].sort();
            const filingStatuses = [...new Set(taxData.map(r => (r['Filing status'] || '').trim()).filter(Boolean))].sort();
            const reviewStatuses = [...new Set(taxData.map(r => (r['Review status with PR'] || '').trim()).filter(Boolean))].sort();
            const persons = [...new Set(taxData.map(r => (r['Person to prepare'] || '').trim()).filter(Boolean))].sort();

            const dueDateSel = document.getElementById('filterDueDateTax');
            dueDateSel.innerHTML = '<option value="">All Due Dates</option>';
            dueDates.forEach(d => dueDateSel.innerHTML += `<option value="${d}">${d}</option>`);

            const filingStatusSel = document.getElementById('filterFilingStatusTax');
            filingStatusSel.innerHTML = '<option value="">All Filing Status</option>';
            filingStatuses.forEach(s => filingStatusSel.innerHTML += `<option value="${s}">${s}</option>`);

            const reviewStatusSel = document.getElementById('filterReviewStatusTax');
            reviewStatusSel.innerHTML = '<option value="">All Review Status</option>';
            reviewStatuses.forEach(s => reviewStatusSel.innerHTML += `<option value="${s}">${s}</option>`);

            const personSel = document.getElementById('filterPersonTax');
            personSel.innerHTML = '<option value="">All Persons</option>';
            persons.forEach(p => personSel.innerHTML += `<option value="${p}">${p}</option>`);
        }

        function applyFiltersTax() {
            const searchTerm = document.getElementById('searchInputTax').value.toLowerCase();
            const dueDateFilter = document.getElementById('filterDueDateTax').value;
            const filingStatusFilter = document.getElementById('filterFilingStatusTax').value;
            const reviewStatusFilter = document.getElementById('filterReviewStatusTax').value;
            const personFilter = document.getElementById('filterPersonTax').value;

            filteredDataTax = taxData.filter(row => {
                if (dueDateFilter && (row['Due date'] || '').trim() !== dueDateFilter) return false;
                if (filingStatusFilter && (row['Filing status'] || '').trim() !== filingStatusFilter) return false;
                if (reviewStatusFilter && (row['Review status with PR'] || '').trim() !== reviewStatusFilter) return false;
                if (personFilter && (row['Person to prepare'] || '').trim() !== personFilter) return false;
                if (searchTerm) {
                    return Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm));
                }
                return true;
            });

            const tbody = document.getElementById('tableBodyTax');
            tbody.innerHTML = '';

            filteredDataTax.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                const originalIndex = taxData.indexOf(row);
                tr.onclick = () => showDetailTax(originalIndex);

                const statusUpdate = row['Status update'] || '';
                let statusClass = 'status-written-off';
                if (statusUpdate.toLowerCase().includes('ready') || statusUpdate.toLowerCase().includes('finalized') || statusUpdate.toLowerCase().includes('complete')) {
                    statusClass = 'status-active';
                } else if (statusUpdate.toLowerCase().includes('waiting') || statusUpdate.toLowerCase().includes('pending') || statusUpdate.toLowerCase().includes('draft')) {
                    statusClass = 'status-sold';
                }

                tr.innerHTML = `
                    <td>${row['Item'] || '-'}</td>
                    <td>${row['Due date'] || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusUpdate || '-'}</span></td>
                    <td>${row['Person to prepare'] || '-'}</td>
                    <td>${row['State report'] || '-'}</td>
                    <td>${row['Review status with PR'] || '-'}</td>
                    <td>${row['Filing status'] || '-'}</td>
                    <td>${row['Confirmation numbers'] || '-'}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        function renderTableTax() {
            applyFiltersTax();
        }

        function clearFiltersTax() {
            document.getElementById('searchInputTax').value = '';
            document.getElementById('filterDueDateTax').value = '';
            document.getElementById('filterFilingStatusTax').value = '';
            document.getElementById('filterReviewStatusTax').value = '';
            document.getElementById('filterPersonTax').value = '';
            applyFiltersTax();
        }

        function sortTableTax(column) {
            if (sortColumnTax === column) {
                sortDirectionTax = sortDirectionTax === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumnTax = column;
                sortDirectionTax = 'asc';
            }

            taxData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                aVal = String(aVal || '').toLowerCase();
                bVal = String(bVal || '').toLowerCase();

                if (sortDirectionTax === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            document.querySelectorAll('#tableSectionTax th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            const activeHeader = Array.from(document.querySelectorAll('#tableSectionTax th')).find(th =>
                th.textContent.includes(column)
            );
            if (activeHeader) {
                activeHeader.classList.add(sortDirectionTax === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            renderTableTax();
        }

        function showDetailTax(index) {
            const row = taxData[index];
            document.getElementById('modalTitle').textContent = row['Item'] || 'Item Details';

            let detailHtml = '<div class="detail-section"><h3>Tax Item Details</h3><div class="detail-grid">';
            Object.entries(row).forEach(([key, value]) => {
                if (key && value) {
                    detailHtml += `
                        <div class="detail-item">
                            <div class="detail-label">${key}</div>
                            <div class="detail-value">${value}</div>
                        </div>
                    `;
                }
            });
            detailHtml += '</div></div>';

            document.getElementById('modalBody').innerHTML = detailHtml;
            document.getElementById('detailModal').classList.add('open');
        }

        function exportCSVTax() {
            if (taxData.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const headers = Object.keys(taxData[0]);
            const csv = [
                headers.join(','),
                ...taxData.map(row =>
                    headers.map(header => {
                        let value = row[header] || '';
                        if (String(value).includes(',') || String(value).includes('"')) {
                            value = '"' + String(value).replace(/"/g, '""') + '"';
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('CSV exported successfully', 'success');
        }

        function renderDashboardAnnual() {
            if (annualData.length === 0) {
                document.getElementById('emptyStateAnnual').style.display = 'flex';
                document.getElementById('statsGridAnnual').style.display = 'none';
                document.getElementById('chartsGridAnnual').style.display = 'none';
                document.getElementById('tableSectionAnnual').style.display = 'none';
                document.getElementById('uploadSectionAnnual').style.display = 'block';
                return;
            }

            document.getElementById('emptyStateAnnual').style.display = 'none';
            document.getElementById('statsGridAnnual').style.display = 'grid';
            document.getElementById('chartsGridAnnual').style.display = 'grid';
            document.getElementById('tableSectionAnnual').style.display = 'block';
            document.getElementById('uploadSectionAnnual').style.display = 'block';

            renderStatsAnnual();
            renderChartsAnnual();
            populateFiltersAnnual();
            renderTableAnnual();
        }

        function renderStatsAnnual() {
            const totalEntities = annualData.filter(row => (row['Entity Name'] || '').trim()).length;
            const paid = annualData.filter(row => {
                const status = (row['Current Status'] || '').toLowerCase();
                return status.includes('paid') || status.includes('complete');
            }).length;
            const notStarted = annualData.filter(row => {
                const status = (row['Current Status'] || '').toLowerCase();
                return status.includes('not started');
            }).length;
            const na = annualData.filter(row => (row['Current Status'] || '').trim() === 'N/A').length;
            const totalTaxDue = annualData.reduce((sum, row) => sum + parseCurrency(row['Tax Amount Due for 2025']), 0);

            document.getElementById('statTotalEntitiesAnnual').textContent = totalEntities;
            document.getElementById('statPaidAnnual').textContent = paid;
            document.getElementById('statNotStartedAnnual').textContent = notStarted;
            document.getElementById('statNAAnnual').textContent = na;
            document.getElementById('statTotalTaxAnnual').textContent = formatCurrency(totalTaxDue);
        }

        function renderChartsAnnual() {
            destroyChartsAnnual();

            const statusCounts = {};
            annualData.forEach(row => {
                let status = (row['Current Status'] || '').trim();
                if (!status) status = 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            chartsAnnual.filingStatusChart = new Chart(document.getElementById('filingStatusChartAnnual'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(status => {
                            if (status.toLowerCase().includes('paid') || status.toLowerCase().includes('complete')) return '#16a34a';
                            if (status.toLowerCase().includes('not started')) return '#ea580c';
                            if (status === 'N/A') return '#9ca3af';
                            return '#2563eb';
                        }),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    }
                }
            });

            const stateCounts = {};
            annualData.forEach(row => {
                const state = (row['State of formation'] || 'Unknown').trim();
                stateCounts[state] = (stateCounts[state] || 0) + 1;
            });

            const sortedStates = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            chartsAnnual.stateChart = new Chart(document.getElementById('stateChartAnnual'), {
                type: 'bar',
                data: {
                    labels: sortedStates.map(s => s[0]),
                    datasets: [{
                        label: 'Entities',
                        data: sortedStates.map(s => s[1]),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1e40af',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text2') }
                        },
                        y: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text2') }
                        }
                    }
                }
            });

            const entityTypeCounts = {};
            annualData.forEach(row => {
                let type = (row['Entity Type'] || 'Unknown').trim();
                if (!type) type = 'Unknown';
                entityTypeCounts[type] = (entityTypeCounts[type] || 0) + 1;
            });

            chartsAnnual.entityTypeChart = new Chart(document.getElementById('entityTypeChartAnnual'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(entityTypeCounts),
                    datasets: [{
                        data: Object.values(entityTypeCounts),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1'],
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    }
                }
            });

            const years = ['2019', '2020', '2021', '2022', '2023', '2025'];
            const complianceData = [];
            const nonComplianceData = [];

            years.forEach(year => {
                const key = `ANNUAL TAX/REPORT ${year}`;
                let compliant = 0;
                let nonCompliant = 0;
                annualData.forEach(row => {
                    const value = (row[key] || '').toLowerCase();
                    if (value === 'true' || value === '1' || value === 'yes') {
                        compliant++;
                    } else if (value === 'false' || value === '0' || value === 'no' || value === '') {
                        nonCompliant++;
                    }
                });
                complianceData.push(compliant);
                nonComplianceData.push(nonCompliant);
            });

            chartsAnnual.complianceChart = new Chart(document.getElementById('complianceChartAnnual'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Compliant',
                            data: complianceData,
                            backgroundColor: '#16a34a',
                            borderColor: '#15803d',
                            borderWidth: 1
                        },
                        {
                            label: 'Non-Compliant',
                            data: nonComplianceData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text2') }
                        },
                        y: {
                            stacked: true,
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text2') }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
                        }
                    }
                }
            });
        }

        function destroyChartsAnnual() {
            Object.values(chartsAnnual).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartsAnnual = {};
        }

        function populateFiltersAnnual() {
            const statuses = [...new Set(annualData.map(r => (r['Current Status'] || '').trim()).filter(Boolean))].sort();
            const states = [...new Set(annualData.map(r => (r['State of formation'] || '').trim()).filter(Boolean))].sort();
            const entityTypes = [...new Set(annualData.map(r => (r['Entity Type'] || '').trim()).filter(Boolean))].sort();
            const persons = [...new Set(annualData.map(r => (r['Person Responsible for filing'] || '').trim()).filter(Boolean))].sort();

            const statusSel = document.getElementById('filterStatusAnnual');
            statusSel.innerHTML = '<option value="">All Statuses</option>';
            statuses.forEach(s => statusSel.innerHTML += `<option value="${s}">${s}</option>`);

            const stateSel = document.getElementById('filterStateAnnual');
            stateSel.innerHTML = '<option value="">All States</option>';
            states.forEach(s => stateSel.innerHTML += `<option value="${s}">${s}</option>`);

            const entityTypeSel = document.getElementById('filterEntityTypeAnnual');
            entityTypeSel.innerHTML = '<option value="">All Entity Types</option>';
            entityTypes.forEach(t => entityTypeSel.innerHTML += `<option value="${t}">${t}</option>`);

            const personSel = document.getElementById('filterPersonResponsibleAnnual');
            personSel.innerHTML = '<option value="">All Persons</option>';
            persons.forEach(p => personSel.innerHTML += `<option value="${p}">${p}</option>`);
        }

        function applyFiltersAnnual() {
            const searchTerm = document.getElementById('searchInputAnnual').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatusAnnual').value;
            const stateFilter = document.getElementById('filterStateAnnual').value;
            const entityTypeFilter = document.getElementById('filterEntityTypeAnnual').value;
            const personFilter = document.getElementById('filterPersonResponsibleAnnual').value;

            filteredDataAnnual = annualData.filter(row => {
                if (statusFilter && (row['Current Status'] || '').trim() !== statusFilter) return false;
                if (stateFilter && (row['State of formation'] || '').trim() !== stateFilter) return false;
                if (entityTypeFilter && (row['Entity Type'] || '').trim() !== entityTypeFilter) return false;
                if (personFilter && (row['Person Responsible for filing'] || '').trim() !== personFilter) return false;
                if (searchTerm) {
                    return Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm));
                }
                return true;
            });

            const tbody = document.getElementById('tableBodyAnnual');
            tbody.innerHTML = '';

            filteredDataAnnual.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                const originalIndex = annualData.indexOf(row);
                tr.onclick = () => showDetailAnnual(originalIndex);

                const currentStatus = row['Current Status'] || '';
                let statusClass = 'status-written-off';
                if (currentStatus.toLowerCase().includes('paid') || currentStatus.toLowerCase().includes('complete')) {
                    statusClass = 'status-active';
                } else if (currentStatus.toLowerCase().includes('not started')) {
                    statusClass = 'status-sold';
                }

                tr.innerHTML = `
                    <td>${row['Entity Name'] || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${currentStatus || '-'}</span></td>
                    <td>${row['State of formation'] || '-'}</td>
                    <td>${row['Due Date'] || '-'}</td>
                    <td class="currency">${formatCurrency(row['Tax Amount Due for 2025'])}</td>
                    <td>${row['Last Filed date'] || '-'}</td>
                    <td>${row['Entity Type'] || '-'}</td>
                    <td>${row['EIN (Federal ID)'] || '-'}</td>
                    <td>${row['Person Responsible for filing'] || '-'}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        function renderTableAnnual() {
            applyFiltersAnnual();
        }

        function clearFiltersAnnual() {
            document.getElementById('searchInputAnnual').value = '';
            document.getElementById('filterStatusAnnual').value = '';
            document.getElementById('filterStateAnnual').value = '';
            document.getElementById('filterEntityTypeAnnual').value = '';
            document.getElementById('filterPersonResponsibleAnnual').value = '';
            applyFiltersAnnual();
        }

        function sortTableAnnual(column) {
            if (sortColumnAnnual === column) {
                sortDirectionAnnual = sortDirectionAnnual === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumnAnnual = column;
                sortDirectionAnnual = 'asc';
            }

            annualData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                const aNum = parseCurrency(aVal);
                const bNum = parseCurrency(bVal);

                if (aNum !== 0 || bNum !== 0) {
                    return sortDirectionAnnual === 'asc' ? aNum - bNum : bNum - aNum;
                }

                aVal = String(aVal || '').toLowerCase();
                bVal = String(bVal || '').toLowerCase();

                if (sortDirectionAnnual === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            document.querySelectorAll('#tableSectionAnnual th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            const activeHeader = Array.from(document.querySelectorAll('#tableSectionAnnual th')).find(th =>
                th.textContent.includes(column)
            );
            if (activeHeader) {
                activeHeader.classList.add(sortDirectionAnnual === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            renderTableAnnual();
        }

        function showDetailAnnual(index) {
            const row = annualData[index];
            document.getElementById('modalTitle').textContent = row['Entity Name'] || 'Entity Details';

            let detailHtml = '<div class="detail-section"><h3>Annual Report Details</h3><div class="detail-grid">';
            Object.entries(row).forEach(([key, value]) => {
                if (key && value) {
                    detailHtml += `
                        <div class="detail-item">
                            <div class="detail-label">${key}</div>
                            <div class="detail-value">${value}</div>
                        </div>
                    `;
                }
            });
            detailHtml += '</div></div>';

            document.getElementById('modalBody').innerHTML = detailHtml;
            document.getElementById('detailModal').classList.add('open');
        }

        function exportCSVAnnual() {
            if (annualData.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const headers = Object.keys(annualData[0]);
            const csv = [
                headers.join(','),
                ...annualData.map(row =>
                    headers.map(header => {
                        let value = row[header] || '';
                        if (String(value).includes(',') || String(value).includes('"')) {
                            value = '"' + String(value).replace(/"/g, '""') + '"';
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `annual_reports_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('CSV exported successfully', 'success');
        }

        function switchTab(tab) {
            const taxContent = document.getElementById('taxContent');
            const annualContent = document.getElementById('annualContent');
            const tabs = document.querySelectorAll('.tab-btn');

            if (tab === 'tax') {
                taxContent.classList.add('active');
                annualContent.classList.remove('active');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                taxContent.classList.remove('active');
                annualContent.classList.add('active');
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        }

        function closeModal(event) {
            if (event && event.target.id !== 'detailModal') return;
            document.getElementById('detailModal').classList.remove('open');
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';

            if (isDark) {
                html.removeAttribute('data-theme');
                localStorage.setItem('nf6_theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('nf6_theme', 'dark');
            }

            destroyChartsTax();
            destroyChartsAnnual();
            if (taxData.length > 0) {
                renderChartsTax();
            }
            if (annualData.length > 0) {
                renderChartsAnnual();
            }
        }

        function initTheme() {
            const theme = localStorage.getItem('nf6_theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        function toggleLang() {
            const current = localStorage.getItem('nf6_lang') || 'EN';
            const next = current === 'EN' ? 'ES' : 'EN';
            localStorage.setItem('nf6_lang', next);
            currentLang = next;
            document.getElementById('langLabel').textContent = next;
            showToast(`Language changed to ${next}`, 'success');
        }

        function initLanguage() {
            const lang = localStorage.getItem('nf6_lang') || 'EN';
            currentLang = lang;
            document.getElementById('langLabel').textContent = lang;
        }

        function initClocks() {
            updateClocks();
            updateTodayBadge();
            setInterval(updateClocks, 1000);
        }

        function updateClocks() {
            const formatter = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'America/Bogota'
            });

            const formatterPR = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'America/Puerto_Rico'
            });

            document.getElementById('clockCOL').textContent = formatter.format(new Date());
            document.getElementById('clockPR').textContent = formatterPR.format(new Date());
        }

        function updateTodayBadge() {
            const today = new Date().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('todayBadge').textContent = today;
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('open');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
        });
    </script>
</body>
</html>
