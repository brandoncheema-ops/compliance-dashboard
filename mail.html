<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail Tracker - NF6 Capital</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f5f7fa;
            --card: #fff;
            --border: #e2e8f0;
            --text: #1a202c;
            --text2: #64748b;
            --accent: #2563eb;
            --accent-lt: #eff6ff;
            --green: #16a34a;
            --green-bg: #f0fdf4;
            --yellow: #ca8a04;
            --yellow-bg: #fefce8;
            --red: #dc2626;
            --red-bg: #fef2f2;
            --orange: #ea580c;
            --orange-bg: #fff7ed;
            --purple: #7c3aed;
            --purple-bg: #f5f3ff;
            --nav: #0f172a;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --text2: #cbd5e1;
            --accent: #3b82f6;
            --accent-lt: #1e3a8a;
            --green-bg: #022c22;
            --yellow-bg: #332701;
            --red-bg: #3f0f0f;
            --orange-bg: #3d1f00;
            --purple-bg: #2d1b4e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Navigation */
        .navbar {
            position: sticky;
            top: 0;
            background-color: var(--nav);
            color: white;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar-left {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex: 1;
        }

        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            list-style: none;
        }

        .nav-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.2s;
            font-size: 0.9rem;
        }

        .nav-links a:hover {
            color: #fff;
        }

        .navbar-right {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .control-btn {
            background: none;
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .clock-display {
            font-size: 0.85rem;
            color: #cbd5e1;
            font-family: 'Courier New', monospace;
        }

        .date-badge {
            background-color: var(--accent);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--text2);
            font-size: 1rem;
        }

        /* Upload Section */
        .upload-section {
            background: var(--card);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: var(--accent);
            background-color: var(--accent-lt);
        }

        .upload-section.dragover {
            border-color: var(--accent);
            background-color: var(--accent-lt);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            margin-bottom: 1rem;
        }

        .upload-text h3 {
            margin-bottom: 0.5rem;
        }

        .upload-text p {
            color: var(--text2);
            font-size: 0.9rem;
        }

        .upload-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: #cbd5e1;
        }

        #csvFile {
            display: none;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card h3 {
            color: var(--text2);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card.accent .number {
            color: var(--green);
        }

        .stat-card.warning .number {
            color: var(--orange);
        }

        .stat-card.danger .number {
            color: var(--red);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .chart-card h3 {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Filter Section */
        .filter-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-section h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text2);
        }

        .filter-group select,
        .filter-group input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: var(--card);
            color: var(--text);
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-lt);
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-clear {
            background-color: var(--border);
            color: var(--text);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background-color: #cbd5e1;
        }

        /* Data Table */
        .table-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .table-section h3 {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-controls {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .table-controls input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        table thead {
            background-color: var(--accent-lt);
            border-bottom: 2px solid var(--border);
        }

        table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            color: var(--text);
        }

        table th:hover {
            background-color: var(--border);
        }

        table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        table tbody tr:hover {
            background-color: var(--accent-lt);
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .badge-high {
            background-color: var(--red-bg);
            color: var(--red);
        }

        .badge-medium {
            background-color: var(--yellow-bg);
            color: var(--yellow);
        }

        .badge-low {
            background-color: var(--green-bg);
            color: var(--green);
        }

        .badge-na {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .badge-completed {
            background-color: var(--green-bg);
            color: var(--green);
        }

        .badge-in-progress {
            background-color: #dbeafe;
            color: #0284c7;
        }

        .badge-pending {
            background-color: var(--yellow-bg);
            color: var(--yellow);
        }

        .badge-not-started {
            background-color: var(--red-bg);
            color: var(--red);
        }

        .badge-filed {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .badge-info {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .badge-bill {
            background-color: var(--purple-bg);
            color: var(--purple);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text2);
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-right: 2rem;
        }

        .modal-header h2 {
            margin-bottom: 0.5rem;
        }

        .modal-body {
            display: grid;
            gap: 1.5rem;
        }

        .modal-field {
            display: grid;
            gap: 0.5rem;
        }

        .modal-field label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }

        .modal-field-value {
            color: var(--text);
            padding: 0.75rem;
            background-color: var(--bg);
            border-radius: 4px;
            word-break: break-word;
        }

        .modal-field-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .modal-field-value a:hover {
            text-decoration: underline;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text2);
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
            }

            .navbar-left {
                gap: 1rem;
                flex-wrap: wrap;
            }

            .nav-links {
                gap: 0.5rem;
                font-size: 0.8rem;
            }

            .navbar-right {
                gap: 0.5rem;
                font-size: 0.8rem;
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.8rem;
            }

            table th, table td {
                padding: 0.75rem 0.5rem;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-left">
            <div class="navbar-brand">NF6 Capital</div>
            <ul class="nav-links">
                <li><a href="index.html" data-i18n="nav_home">HomeBase</a></li>
                <li><a href="compliance-dashboard.html" data-i18n="nav_dashboard">Dashboard</a></li>
                <li><a href="compliance-calendar.html" data-i18n="nav_calendar">Calendar</a></li>
                <li><a href="audit-trail.html" data-i18n="nav_audit">Audit Trail</a></li>
                <li><a href="upload.html" data-i18n="nav_upload">Upload</a></li>
                <li><a href="documents.html" data-i18n="nav_documents">Documents</a></li>
            </ul>
        </div>
        <div class="navbar-right">
            <button class="control-btn" id="langToggle" data-i18n="btn_lang">EN/ES</button>
            <button class="control-btn" id="darkToggle" data-i18n="btn_dark">ðŸŒ™ Dark</button>
            <div class="clock-display">COL: <span id="colClock">--:--:--</span></div>
            <div class="clock-display">PR: <span id="prClock">--:--:--</span></div>
            <div class="date-badge" id="dateBadge">--/--/--</div>
            <button class="control-btn" id="signOut" data-i18n="btn_signout">Sign Out</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 data-i18n="page_title">Mail Tracker</h1>
            <p data-i18n="page_subtitle">Track incoming and outgoing mail, certified letters, notices, and important correspondence.</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadZone">
            <div class="upload-icon">ðŸ“¨</div>
            <div class="upload-text">
                <h3 data-i18n="upload_title">Upload Mail Tracker CSV</h3>
                <p data-i18n="upload_desc">Drag and drop your CSV file here, or use the buttons below to upload or connect to Google Sheets</p>
            </div>
            <div class="upload-controls">
                <button class="btn btn-primary" id="chooseFileBtn" data-i18n="btn_choose">Choose CSV File</button>
                <button class="btn btn-secondary" id="sheetsBtn" data-i18n="btn_sheets">Google Sheets URL</button>
                <button class="btn btn-secondary" id="exportBtn" data-i18n="btn_export">Export CSV</button>
            </div>
            <input type="file" id="csvFile" accept=".csv" />
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 data-i18n="stat_total">Total Mail Items</h3>
                <div class="number" id="statTotal">0</div>
            </div>
            <div class="stat-card danger">
                <h3 data-i18n="stat_high">High Priority</h3>
                <div class="number" id="statHigh">0</div>
            </div>
            <div class="stat-card warning">
                <h3 data-i18n="stat_action">Action Required</h3>
                <div class="number" id="statAction">0</div>
            </div>
            <div class="stat-card accent">
                <h3 data-i18n="stat_completed">Completed</h3>
                <div class="number" id="statCompleted">0</div>
            </div>
            <div class="stat-card">
                <h3 data-i18n="stat_month">This Month</h3>
                <div class="number" id="statMonth">0</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3 data-i18n="chart_priority">Mail by Priority</h3>
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 data-i18n="chart_status">Mail by Status</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 data-i18n="chart_senders">Top 10 Senders</h3>
                <div class="chart-container">
                    <canvas id="sendersChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 data-i18n="chart_month">Mail by Month</h3>
                <div class="chart-container">
                    <canvas id="monthChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h3 data-i18n="filter_title">Filters</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="filterPriority" data-i18n="filter_priority">Priority</label>
                    <select id="filterPriority">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterStatus" data-i18n="filter_status">Status</label>
                    <select id="filterStatus">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterSender" data-i18n="filter_sender">Sender</label>
                    <select id="filterSender">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterAddressed" data-i18n="filter_addressed">Addressed To</label>
                    <select id="filterAddressed">
                        <option value="">All</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-clear" id="clearFiltersBtn" data-i18n="btn_clear">Clear Filters</button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-section">
            <h3 data-i18n="table_title">Mail Items</h3>
            <div class="table-controls">
                <input type="text" id="searchInput" placeholder="Search mail..." data-i18n-placeholder="search_placeholder">
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th data-column="Date Received" data-i18n="col_date">Date Received</th>
                            <th data-column="Sender" data-i18n="col_sender">Sender</th>
                            <th data-column="Mail Heading" data-i18n="col_heading">Mail Heading</th>
                            <th data-column="Addressed To" data-i18n="col_addressed">Addressed To</th>
                            <th data-column="Priority" data-i18n="col_priority">Priority</th>
                            <th data-column="Status" data-i18n="col_status">Status</th>
                            <th data-column="Lead" data-i18n="col_lead">Lead</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3 data-i18n="empty_title">No mail items found</h3>
                <p data-i18n="empty_desc">Upload a CSV file to get started</p>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <div class="modal-header">
                <h2 data-i18n="modal_title">Mail Item Details</h2>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <script>
        // ===== Translations =====
        const translations = {
            en: {
                nav_home: 'HomeBase',
                nav_dashboard: 'Dashboard',
                nav_calendar: 'Calendar',
                nav_audit: 'Audit Trail',
                nav_upload: 'Upload',
                nav_documents: 'Documents',
                btn_lang: 'EN/ES',
                btn_dark: 'ðŸŒ™ Dark',
                btn_signout: 'Sign Out',
                page_title: 'Mail Tracker',
                page_subtitle: 'Track incoming and outgoing mail, certified letters, notices, and important correspondence.',
                upload_title: 'Upload Mail Tracker CSV',
                upload_desc: 'Drag and drop your CSV file here, or use the buttons below to upload or connect to Google Sheets',
                btn_choose: 'Choose CSV File',
                btn_sheets: 'Google Sheets URL',
                btn_export: 'Export CSV',
                stat_total: 'Total Mail Items',
                stat_high: 'High Priority',
                stat_action: 'Action Required',
                stat_completed: 'Completed',
                stat_month: 'This Month',
                chart_priority: 'Mail by Priority',
                chart_status: 'Mail by Status',
                chart_senders: 'Top 10 Senders',
                chart_month: 'Mail by Month',
                filter_title: 'Filters',
                filter_priority: 'Priority',
                filter_status: 'Status',
                filter_sender: 'Sender',
                filter_addressed: 'Addressed To',
                btn_clear: 'Clear Filters',
                table_title: 'Mail Items',
                search_placeholder: 'Search mail...',
                col_date: 'Date Received',
                col_sender: 'Sender',
                col_heading: 'Mail Heading',
                col_addressed: 'Addressed To',
                col_priority: 'Priority',
                col_status: 'Status',
                col_lead: 'Lead',
                empty_title: 'No mail items found',
                empty_desc: 'Upload a CSV file to get started',
                modal_title: 'Mail Item Details'
            },
            es: {
                nav_home: 'HomeBase',
                nav_dashboard: 'Panel de Control',
                nav_calendar: 'Calendario',
                nav_audit: 'Pista de AuditorÃ­a',
                nav_upload: 'Subir',
                nav_documents: 'Documentos',
                btn_lang: 'EN/ES',
                btn_dark: 'ðŸŒ™ Oscuro',
                btn_signout: 'Cerrar SesiÃ³n',
                page_title: 'Rastreador de Correo',
                page_subtitle: 'Rastrear correo entrante y saliente, cartas certificadas, avisos y correspondencia importante.',
                upload_title: 'Subir CSV del Rastreador de Correo',
                upload_desc: 'Arrastra y suelta tu archivo CSV aquÃ­, o usa los botones a continuaciÃ³n para subir o conectarte a Google Sheets',
                btn_choose: 'Elegir Archivo CSV',
                btn_sheets: 'URL de Google Sheets',
                btn_export: 'Exportar CSV',
                stat_total: 'Total de Elementos de Correo',
                stat_high: 'Prioridad Alta',
                stat_action: 'AcciÃ³n Requerida',
                stat_completed: 'Completado',
                stat_month: 'Este Mes',
                chart_priority: 'Correo por Prioridad',
                chart_status: 'Correo por Estado',
                chart_senders: 'Top 10 Remitentes',
                chart_month: 'Correo por Mes',
                filter_title: 'Filtros',
                filter_priority: 'Prioridad',
                filter_status: 'Estado',
                filter_sender: 'Remitente',
                filter_addressed: 'Dirigido a',
                btn_clear: 'Limpiar Filtros',
                table_title: 'Elementos de Correo',
                search_placeholder: 'Buscar correo...',
                col_date: 'Fecha Recibida',
                col_sender: 'Remitente',
                col_heading: 'Encabezado de Correo',
                col_addressed: 'Dirigido a',
                col_priority: 'Prioridad',
                col_status: 'Estado',
                col_lead: 'Asignado',
                empty_title: 'No se encontraron elementos de correo',
                empty_desc: 'Sube un archivo CSV para comenzar',
                modal_title: 'Detalles del Elemento de Correo'
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentTheme = localStorage.getItem('theme') || 'light';
        let mailData = JSON.parse(localStorage.getItem('nf6_mail_data')) || [];
        let filteredData = [];
        let sortColumn = null;
        let sortOrder = 'asc';

        // ===== Firebase =====
        const firebaseConfig = {
            apiKey: "AIzaSyAbvvj4qCzfZPdRxU6BtbRSfXDXPitNwkQ",
            authDomain: "nf6-compliance.firebaseapp.com",
            projectId: "nf6-compliance",
            storageBucket: "nf6-compliance.appspot.com",
            messagingSenderId: "606372",
            appId: "1:606372:web:abc123"
        };
        const ALLOWED_DOMAIN = 'nf6capital.com';

        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.log('Firebase already initialized');
        }

        const auth = firebase.auth();

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            applyLanguage();
            updateClocks();
            updateDateBadge();
            setInterval(updateClocks, 1000);

            setupEventListeners();
            renderTable();
            updateStats();
            populateFilters();
            renderCharts();
        });

        // ===== Theme =====
        function applyTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            const darkToggle = document.getElementById('darkToggle');
            if (darkToggle) {
                darkToggle.textContent = currentTheme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
            }
        }

        document.getElementById('darkToggle').addEventListener('click', () => {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            applyTheme();
        });

        // ===== Language =====
        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = translations[currentLanguage][key] || key;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[currentLanguage][key] || key;
            });
        }

        document.getElementById('langToggle').addEventListener('click', () => {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            localStorage.setItem('language', currentLanguage);
            applyLanguage();
        });

        // ===== Clock =====
        function updateClocks() {
            const colTime = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const prTime = new Date().toLocaleString('en-US', { timeZone: 'America/New_York', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

            document.getElementById('colClock').textContent = colTime;
            document.getElementById('prClock').textContent = prTime;
        }

        function updateDateBadge() {
            const now = new Date();
            const options = { month: '2-digit', day: '2-digit', year: '2-digit' };
            document.getElementById('dateBadge').textContent = now.toLocaleDateString('en-US', options);
        }

        // ===== Event Listeners =====
        function setupEventListeners() {
            document.getElementById('chooseFileBtn').addEventListener('click', () => {
                document.getElementById('csvFile').click();
            });

            document.getElementById('csvFile').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    parseCSV(e.target.files[0]);
                }
            });

            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    parseCSV(e.dataTransfer.files[0]);
                }
            });

            document.getElementById('sheetsBtn').addEventListener('click', () => {
                const url = prompt('Enter Google Sheets CSV export URL:');
                if (url) {
                    localStorage.setItem('nf6_sheets_url_mail', url);
                    alert('Google Sheets URL saved!');
                }
            });

            document.getElementById('exportBtn').addEventListener('click', () => {
                exportToCSV();
            });

            document.getElementById('signOut').addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });

            // Filters
            document.getElementById('filterPriority').addEventListener('change', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
            document.getElementById('filterSender').addEventListener('change', applyFilters);
            document.getElementById('filterAddressed').addEventListener('change', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

            // Search
            document.getElementById('searchInput').addEventListener('input', applyFilters);

            // Table headers
            document.querySelectorAll('table th').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-column');
                    if (sortColumn === column) {
                        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortOrder = 'asc';
                    }
                    renderTable();
                });
            });

            // Modal
            document.getElementById('modalClose').addEventListener('click', () => {
                document.getElementById('detailModal').classList.remove('active');
            });

            document.getElementById('detailModal').addEventListener('click', (e) => {
                if (e.target.id === 'detailModal') {
                    document.getElementById('detailModal').classList.remove('active');
                }
            });
        }

        // ===== CSV Parsing =====
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    mailData = normalizeKeys(results.data).filter(row => Object.values(row).some(v => v));
                    localStorage.setItem('nf6_mail_data', JSON.stringify(mailData));
                    applyFilters();
                    updateStats();
                    populateFilters();
                    renderCharts();
                    alert('CSV loaded successfully! ' + mailData.length + ' items.');
                },
                error: (error) => {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function normalizeKeys(data) {
            return data.map(row => {
                const clean = {};
                Object.keys(row).forEach(k => {
                    clean[k.trim()] = row[k];
                });
                return clean;
            });
        }

        // ===== Filters =====
        function applyFilters() {
            const priority = document.getElementById('filterPriority').value;
            const status = document.getElementById('filterStatus').value;
            const sender = document.getElementById('filterSender').value;
            const addressed = document.getElementById('filterAddressed').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredData = mailData.filter(row => {
                if (priority && row['Priority'] !== priority) return false;
                if (status && row['Status'] !== status) return false;
                if (sender && row['Sender'] !== sender) return false;
                if (addressed && row['Addressed To'] !== addressed) return false;
                if (search) {
                    const searchFields = [
                        row['Date Received'],
                        row['Sender'],
                        row['Mail Heading'],
                        row['Addressed To'],
                        row['Priority'],
                        row['Status'],
                        row['Lead']
                    ].join(' ').toLowerCase();
                    if (!searchFields.includes(search)) return false;
                }
                return true;
            });

            renderTable();
        }

        function clearFilters() {
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterSender').value = '';
            document.getElementById('filterAddressed').value = '';
            document.getElementById('searchInput').value = '';
            filteredData = [...mailData];
            renderTable();
        }

        function populateFilters() {
            const priorities = [...new Set(mailData.map(r => r['Priority']).filter(Boolean))].sort();
            const statuses = [...new Set(mailData.map(r => r['Status']).filter(Boolean))].sort();
            const senders = [...new Set(mailData.map(r => r['Sender']).filter(Boolean))].sort().slice(0, 10);
            const addressed = [...new Set(mailData.map(r => r['Addressed To']).filter(Boolean))].sort();

            populateSelect('filterPriority', priorities);
            populateSelect('filterStatus', statuses);
            populateSelect('filterSender', senders);
            populateSelect('filterAddressed', addressed);
        }

        function populateSelect(id, values) {
            const select = document.getElementById(id);
            const current = select.value;
            select.innerHTML = '<option value="">All</option>';
            values.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
            select.value = current;
        }

        // ===== Table =====
        function renderTable() {
            const body = document.getElementById('tableBody');
            const empty = document.getElementById('emptyState');

            let displayData = [...filteredData];

            if (sortColumn) {
                displayData.sort((a, b) => {
                    let aVal = a[sortColumn] || '';
                    let bVal = b[sortColumn] || '';

                    if (!isNaN(aVal) && !isNaN(bVal)) {
                        aVal = parseFloat(aVal);
                        bVal = parseFloat(bVal);
                    }

                    if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            if (displayData.length === 0) {
                body.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            body.innerHTML = displayData.map((row, idx) => `
                <tr onclick="openDetailModal(${idx})">
                    <td>${formatDate(row['Date Received'])}</td>
                    <td>${row['Sender'] || '-'}</td>
                    <td>${row['Mail Heading'] || '-'}</td>
                    <td>${row['Addressed To'] || '-'}</td>
                    <td>${getPriorityBadge(row['Priority'])}</td>
                    <td>${getStatusBadge(row['Status'])}</td>
                    <td>${row['Lead'] || '-'}</td>
                </tr>
            `).join('');
        }

        function getPriorityBadge(priority) {
            if (!priority) return '<span class="badge badge-na">None</span>';
            if (priority === 'High') return '<span class="badge badge-high">High</span>';
            if (priority === 'Medium') return '<span class="badge badge-medium">Medium</span>';
            if (priority === 'Low') return '<span class="badge badge-low">Low</span>';
            return '<span class="badge badge-na">N/A</span>';
        }

        function getStatusBadge(status) {
            if (!status) return '<span class="badge badge-na">-</span>';
            if (status === 'Completed') return '<span class="badge badge-completed">Completed</span>';
            if (status === 'In Progress') return '<span class="badge badge-in-progress">In Progress</span>';
            if (status === 'Pending') return '<span class="badge badge-pending">Pending</span>';
            if (status === 'Not started') return '<span class="badge badge-not-started">Not Started</span>';
            if (status === 'Filed - nothing to do') return '<span class="badge badge-filed">Filed</span>';
            if (status === 'Info - nothing to do') return '<span class="badge badge-info">Info</span>';
            if (status === 'Bill - on autopay') return '<span class="badge badge-bill">Autopay</span>';
            return '<span class="badge badge-na">' + status + '</span>';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function openDetailModal(idx) {
            const row = filteredData[idx];
            const body = document.getElementById('modalBody');

            body.innerHTML = `
                <div class="modal-field">
                    <label>Date Received</label>
                    <div class="modal-field-value">${formatDate(row['Date Received'])}</div>
                </div>
                <div class="modal-field">
                    <label>Sender</label>
                    <div class="modal-field-value">${row['Sender'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Mail Heading</label>
                    <div class="modal-field-value">${row['Mail Heading'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Addressed To</label>
                    <div class="modal-field-value">${row['Addressed To'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Priority</label>
                    <div class="modal-field-value">${row['Priority'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Status</label>
                    <div class="modal-field-value">${row['Status'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Lead</label>
                    <div class="modal-field-value">${row['Lead'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Action Items</label>
                    <div class="modal-field-value">${row['Action Items'] || '-'}</div>
                </div>
                <div class="modal-field">
                    <label>Drive Link</label>
                    <div class="modal-field-value">
                        ${row['Drive Link'] ? `<a href="${row['Drive Link']}" target="_blank">View Document</a>` : '-'}
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        // ===== Stats =====
        function updateStats() {
            const total = mailData.length;
            const high = mailData.filter(r => r['Priority'] === 'High').length;
            const actionRequired = mailData.filter(r =>
                (r['Action Items'] && r['Action Items'].trim()) ||
                r['Status'] === 'In Progress' ||
                r['Status'] === 'Pending' ||
                r['Status'] === 'Not started'
            ).length;
            const completed = mailData.filter(r => r['Status'] === 'Completed').length;

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const thisMonth = mailData.filter(r => {
                const d = new Date(r['Date Received']);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statHigh').textContent = high;
            document.getElementById('statAction').textContent = actionRequired;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statMonth').textContent = thisMonth;
        }

        // ===== Charts =====
        let priorityChart, statusChart, sendersChart, monthChart;

        function renderCharts() {
            renderPriorityChart();
            renderStatusChart();
            renderSendersChart();
            renderMonthChart();
        }

        function renderPriorityChart() {
            const counts = {};
            ['High', 'Medium', 'Low', 'N/A - info only'].forEach(p => counts[p] = 0);
            counts['None'] = 0;

            mailData.forEach(row => {
                const p = row['Priority'] || 'None';
                if (p in counts) counts[p]++;
                else if (p) counts[p] = 1;
            });

            const ctx = document.getElementById('priorityChart').getContext('2d');
            if (priorityChart) priorityChart.destroy();

            priorityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#dc2626', '#ca8a04', '#16a34a', '#9ca3af', '#6b7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderStatusChart() {
            const counts = {};
            const statuses = ['Completed', 'In Progress', 'Pending', 'Not started', 'Filed - nothing to do', 'Info - nothing to do', 'Bill - on autopay'];
            statuses.forEach(s => counts[s] = 0);

            mailData.forEach(row => {
                const s = row['Status'] || '';
                if (s && s in counts) counts[s]++;
                else if (s) counts[s] = 1;
            });

            const labels = Object.keys(counts).filter(k => counts[k] > 0);
            const data = labels.map(k => counts[k]);

            const colors = [];
            labels.forEach(l => {
                if (l === 'Completed') colors.push('#16a34a');
                else if (l === 'In Progress') colors.push('#0284c7');
                else if (l === 'Pending') colors.push('#ca8a04');
                else if (l === 'Not started') colors.push('#dc2626');
                else colors.push('#9ca3af');
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: colors }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderSendersChart() {
            const counts = {};
            mailData.forEach(row => {
                const sender = row['Sender'] || 'Unknown';
                counts[sender] = (counts[sender] || 0) + 1;
            });

            const sorted = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sorted.map(([s]) => s);
            const data = sorted.map(([, c]) => c);

            const ctx = document.getElementById('sendersChart').getContext('2d');
            if (sendersChart) sendersChart.destroy();

            sendersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Count',
                        data,
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderMonthChart() {
            const months = {};

            mailData.forEach(row => {
                const dateStr = row['Date Received'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    if (!isNaN(date)) {
                        const key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        months[key] = (months[key] || 0) + 1;
                    }
                }
            });

            const sorted = Object.entries(months).sort((a, b) => {
                return new Date(a[0]) - new Date(b[0]);
            });

            const labels = sorted.map(([m]) => m);
            const data = sorted.map(([, c]) => c);

            const ctx = document.getElementById('monthChart').getContext('2d');
            if (monthChart) monthChart.destroy();

            monthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Mail Items',
                        data,
                        backgroundColor: '#16a34a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ===== Export =====
        function exportToCSV() {
            if (mailData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(mailData[0]);
            const csv = [
                headers.join(','),
                ...mailData.map(row =>
                    headers.map(h => {
                        const val = row[h] || '';
                        if (val.includes(',') || val.includes('"')) {
                            return '"' + val.replace(/"/g, '""') + '"';
                        }
                        return val;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mail_tracker_export.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>