<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>NF6 Capital &mdash; Document Finder</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

:root,[data-theme="light"]{
  --bg:#f5f7fa;--card:#fff;--border:#e2e8f0;--text:#1a202c;--text2:#64748b;
  --accent:#2563eb;--accent-lt:#eff6ff;--green:#16a34a;--green-bg:#f0fdf4;
  --yellow:#ca8a04;--yellow-bg:#fefce8;--red:#dc2626;--red-bg:#fef2f2;
  --orange:#ea580c;--orange-bg:#fff7ed;--purple:#7c3aed;--purple-bg:#f5f3ff;
  --nav:#0f172a;--sidebar-bg:#f8fafc;--sidebar-active:#eff6ff;--card-shadow:0 1px 3px rgba(0,0,0,.06);
}
[data-theme="dark"]{
  --bg:#0f172a;--card:#1e293b;--border:#334155;--text:#e2e8f0;--text2:#94a3b8;
  --accent:#60a5fa;--accent-lt:#1e3a5f;--green:#4ade80;--green-bg:#064e3b;
  --yellow:#fbbf24;--yellow-bg:#713f12;--red:#f87171;--red-bg:#7f1d1d;
  --orange:#fb923c;--orange-bg:#7c2d12;--purple:#a78bfa;--purple-bg:#4c1d95;
  --nav:#020617;--sidebar-bg:#0f172a;--sidebar-active:#1e3a5f;--card-shadow:0 1px 3px rgba(0,0,0,.3);
}
[data-theme="dark"] .folder-tree-item:hover{background:#334155}
[data-theme="dark"] .file-row:hover{background:#334155}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased;transition:background .3s,color .3s}

/* ── NAV ── */
nav{background:var(--nav);color:#fff;padding:0 1.25rem;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.brand{font-weight:700;font-size:1.1rem;letter-spacing:-.02em;white-space:nowrap;text-decoration:none;color:#fff}.brand span{color:#60a5fa}
.nav-links{display:flex;gap:.5rem}.nav-links a{color:#94a3b8;text-decoration:none;font-size:.82rem;font-weight:500;padding:.35rem .5rem;border-radius:6px;transition:color .2s}
.nav-links a:hover,.nav-links a.active{color:#fff}
.nav-right{display:flex;align-items:center;gap:.4rem}
.toggle-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#94a3b8;padding:.3rem .55rem;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;white-space:nowrap;display:flex;align-items:center;gap:.25rem}
.toggle-btn:hover{color:#fff;background:rgba(255,255,255,.15)}
.toggle-btn .icon{font-size:.8rem}
.nav-clocks{display:flex;gap:.35rem;align-items:center}
.clock-circle{width:48px;height:48px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#1e293b,#0f172a);border:2px solid #334155;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 10px rgba(96,165,250,.12),inset 0 1px 2px rgba(0,0,0,.3);position:relative;overflow:hidden}
.clock-circle::before{content:'';position:absolute;inset:-1px;border-radius:50%;background:conic-gradient(from 0deg,#60a5fa 0%,#3b82f6 25%,#1e40af 50%,#3b82f6 75%,#60a5fa 100%);opacity:.15;z-index:0}
.clock-circle .clock-label{font-size:.38rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#94a3b8;z-index:1;line-height:1}
.clock-circle .clock-time{font-family:'Courier New',monospace;font-size:.55rem;font-weight:700;color:#60a5fa;z-index:1;line-height:1.2}
.today-badge{background:#1e3a5f;color:#93c5fd;font-size:.68rem;padding:3px 8px;border-radius:6px;font-weight:500;white-space:nowrap}
.sign-out-btn{background:none;border:1px solid #334155;color:#94a3b8;padding:.3rem .55rem;border-radius:6px;font-size:.7rem;cursor:pointer;font-family:inherit}
.sign-out-btn:hover{color:#fff;border-color:#94a3b8}
.hamburger{display:none;background:none;border:none;color:#fff;font-size:1.4rem;cursor:pointer;padding:.25rem}
.mobile-menu{display:none;position:fixed;top:56px;left:0;right:0;background:var(--nav);padding:.75rem;z-index:99;flex-direction:column;gap:.35rem}
.mobile-menu.open{display:flex}
.mobile-menu a{color:#94a3b8;text-decoration:none;padding:.6rem .75rem;border-radius:8px;font-size:.9rem}
.mobile-menu a:hover,.mobile-menu a.active{color:#fff;background:#1e293b}

/* ── MAIN LAYOUT ── */
.app-layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 56px)}

/* ── SIDEBAR ── */
.sidebar{background:var(--sidebar-bg);border-right:1px solid var(--border);padding:1rem 0;overflow-y:auto;transition:background .3s}
.sidebar-header{padding:0 1rem .75rem;display:flex;justify-content:space-between;align-items:center}
.sidebar-title{font-size:.85rem;font-weight:700;letter-spacing:-.01em}
.sidebar-count{font-size:.65rem;color:var(--text2);background:var(--card);border:1px solid var(--border);padding:2px 6px;border-radius:6px}
.folder-tree{list-style:none}
.folder-entity{margin-bottom:.25rem}
.folder-entity-header{display:flex;align-items:center;gap:.4rem;padding:.45rem 1rem;cursor:pointer;font-size:.82rem;font-weight:600;transition:background .15s;border-radius:0}
.folder-entity-header:hover{background:var(--sidebar-active)}
.folder-entity-header .arrow{font-size:.6rem;transition:transform .2s;width:12px;text-align:center;color:var(--text2)}
.folder-entity-header .arrow.open{transform:rotate(90deg)}
.folder-entity-header .entity-icon{font-size:.9rem}
.folder-entity-header .entity-name{flex:1}
.folder-entity-header .entity-count{font-size:.65rem;color:var(--text2);background:var(--card);border:1px solid var(--border);padding:1px 5px;border-radius:4px}
.folder-categories{list-style:none;display:none;padding-left:1.5rem}
.folder-categories.open{display:block}
.folder-cat-item{display:flex;align-items:center;gap:.35rem;padding:.35rem .75rem;cursor:pointer;font-size:.78rem;color:var(--text2);transition:all .15s;border-radius:6px;margin:1px 0}
.folder-cat-item:hover{background:var(--sidebar-active);color:var(--text)}
.folder-cat-item.active{background:var(--accent-lt);color:var(--accent);font-weight:600}
.folder-cat-item .cat-icon{font-size:.75rem}
.folder-cat-item .cat-count{margin-left:auto;font-size:.62rem;background:var(--card);border:1px solid var(--border);padding:1px 4px;border-radius:4px}
.all-docs-btn{display:flex;align-items:center;gap:.4rem;padding:.5rem 1rem;cursor:pointer;font-size:.82rem;font-weight:600;color:var(--accent);transition:background .15s;margin-bottom:.5rem;border-bottom:1px solid var(--border);padding-bottom:.75rem}
.all-docs-btn:hover{background:var(--sidebar-active)}
.all-docs-btn.active{background:var(--accent-lt)}

/* ── MAIN CONTENT ── */
.main-content{padding:1.25rem 1.5rem;overflow-y:auto}

/* TOOLBAR */
.toolbar{display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap}
.search-box{flex:1;min-width:220px;position:relative}
.search-box input{width:100%;padding:.55rem .75rem .55rem 2.2rem;border:1px solid var(--border);border-radius:8px;font-size:.82rem;font-family:inherit;background:var(--card);color:var(--text);outline:none;transition:border-color .2s}
.search-box input:focus{border-color:var(--accent)}
.search-box::before{content:'\1F50D';position:absolute;left:.65rem;top:50%;transform:translateY(-50%);font-size:.75rem;pointer-events:none}
.toolbar-btn{display:inline-flex;align-items:center;gap:.3rem;padding:.5rem .85rem;border:1px solid var(--border);border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;font-family:inherit;background:var(--card);color:var(--text2);transition:all .2s;white-space:nowrap}
.toolbar-btn:hover{border-color:var(--accent);color:var(--accent)}
.toolbar-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.toolbar-btn.primary:hover{background:#1d4ed8}
.view-toggle{display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.view-toggle button{padding:.45rem .6rem;border:none;background:var(--card);color:var(--text2);cursor:pointer;font-size:.78rem;font-family:inherit;transition:all .15s}
.view-toggle button.active{background:var(--accent);color:#fff}

/* STATS BAR */
.stats-bar{display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
.stat-pill{display:flex;align-items:center;gap:.3rem;padding:.35rem .65rem;background:var(--card);border:1px solid var(--border);border-radius:8px;font-size:.72rem;font-weight:500;color:var(--text2)}
.stat-pill strong{color:var(--text);font-weight:700}

/* BREADCRUMB */
.breadcrumb{display:flex;align-items:center;gap:.3rem;margin-bottom:.75rem;font-size:.78rem;color:var(--text2);flex-wrap:wrap}
.breadcrumb a{color:var(--accent);text-decoration:none;font-weight:500;cursor:pointer}
.breadcrumb a:hover{text-decoration:underline}
.breadcrumb .sep{color:var(--border)}

/* FILE LIST */
.file-list-header{display:grid;grid-template-columns:1fr 120px 100px 90px 50px;gap:.5rem;padding:.5rem .75rem;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text2);border-bottom:1px solid var(--border)}
.file-row{display:grid;grid-template-columns:1fr 120px 100px 90px 50px;gap:.5rem;padding:.6rem .75rem;border-bottom:1px solid var(--border);align-items:center;transition:background .15s;cursor:pointer;font-size:.8rem}
.file-row:hover{background:var(--sidebar-active)}
.file-name{display:flex;align-items:center;gap:.5rem;min-width:0}
.file-icon{font-size:1.1rem;flex-shrink:0}
.file-info{min-width:0}
.file-info .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-info .path{font-size:.68rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-entity{font-size:.72rem}
.file-category{font-size:.72rem}
.file-date{font-size:.72rem;color:var(--text2)}
.file-actions{display:flex;gap:.25rem}
.file-action-btn{padding:3px 6px;border:1px solid var(--border);border-radius:4px;background:var(--card);font-size:.65rem;cursor:pointer;color:var(--text2);transition:all .15s}
.file-action-btn:hover{border-color:var(--accent);color:var(--accent)}
.file-action-btn.delete:hover{border-color:var(--red);color:var(--red)}

/* GRID VIEW */
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.75rem}
.file-grid-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;text-align:center;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.4rem}
.file-grid-card:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,.08);transform:translateY(-2px)}
.file-grid-icon{font-size:2.5rem}
.file-grid-name{font-size:.78rem;font-weight:600;word-break:break-word;line-height:1.3}
.file-grid-meta{font-size:.65rem;color:var(--text2)}

/* BADGES */
.badge{display:inline-block;padding:2px 7px;border-radius:6px;font-size:.66rem;font-weight:600;white-space:nowrap}
.badge-tax{background:var(--green-bg);color:var(--green)}
.badge-legal{background:var(--purple-bg);color:var(--purple)}
.badge-insurance{background:var(--accent-lt);color:var(--accent)}
.badge-compliance{background:var(--yellow-bg);color:var(--yellow)}
.badge-banking{background:#e0f2fe;color:#0369a1}
.badge-contracts{background:var(--orange-bg);color:var(--orange)}
.badge-property{background:#fce7f3;color:#be185d}
.badge-maintenance{background:#f0fdf4;color:#15803d}
.badge-govt{background:var(--red-bg);color:var(--red)}
.badge-other{background:#f1f5f9;color:#64748b}

/* UPLOAD ZONE */
.upload-zone{border:2px dashed var(--border);border-radius:14px;padding:2rem 1.5rem;text-align:center;cursor:pointer;transition:all .2s;background:var(--card);margin-bottom:1rem}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:var(--accent-lt)}
.upload-zone .icon{font-size:2rem;margin-bottom:.3rem}
.upload-zone h3{font-size:.95rem;font-weight:600;margin-bottom:.15rem}
.upload-zone p{color:var(--text2);font-size:.78rem}

/* UPLOAD MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:center;justify-content:center;padding:.75rem}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border-radius:16px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:1;border-radius:16px 16px 0 0}
.modal-header h2{font-size:1.05rem;font-weight:700}
.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text2);padding:.25rem}
.modal-body{padding:1.25rem}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.6rem}
.form-group{display:flex;flex-direction:column;gap:.2rem}
.form-group.full{grid-column:1/-1}
.form-group label{font-size:.7rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.03em}
.form-group input,.form-group select{padding:.5rem .65rem;border:1px solid var(--border);border-radius:8px;font-size:.82rem;font-family:inherit;background:var(--card);color:var(--text);outline:none}
.form-group input:focus,.form-group select:focus{border-color:var(--accent)}
.modal-footer{padding:.875rem 1.25rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.4rem}
.btn{padding:.45rem 1rem;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;font-family:inherit;border:1px solid var(--border);background:var(--card);color:var(--text);transition:all .2s}
.btn:hover{background:var(--sidebar-bg)}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn-primary:hover{background:#1d4ed8}
.btn-danger{background:var(--red);color:#fff;border-color:var(--red)}

/* FILE DROP LIST IN MODAL */
.file-drop-list{margin:.75rem 0;max-height:200px;overflow-y:auto}
.file-drop-item{display:flex;align-items:center;gap:.5rem;padding:.4rem .5rem;background:var(--sidebar-bg);border:1px solid var(--border);border-radius:6px;margin-bottom:.3rem;font-size:.78rem}
.file-drop-item .fdi-icon{font-size:1rem}
.file-drop-item .fdi-name{flex:1;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-drop-item .fdi-size{color:var(--text2);font-size:.7rem}
.file-drop-item .fdi-remove{background:none;border:none;color:var(--red);cursor:pointer;font-size:.85rem;padding:2px}

/* EMPTY STATE */
.empty-state{text-align:center;padding:3rem 1.5rem;color:var(--text2)}
.empty-state .empty-icon{font-size:3rem;margin-bottom:.75rem}
.empty-state h3{font-size:1.1rem;color:var(--text);font-weight:700;margin-bottom:.25rem}
.empty-state p{font-size:.85rem}

/* PREVIEW PANEL */
.preview-panel{position:fixed;top:56px;right:0;width:400px;height:calc(100vh - 56px);background:var(--card);border-left:1px solid var(--border);z-index:150;transform:translateX(100%);transition:transform .3s;display:flex;flex-direction:column}
.preview-panel.open{transform:translateX(0)}
.preview-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.preview-header h3{font-size:.9rem;font-weight:700}
.preview-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text2)}
.preview-body{flex:1;overflow-y:auto;padding:1rem}
.preview-icon-large{font-size:4rem;text-align:center;margin:1rem 0}
.preview-meta{display:flex;flex-direction:column;gap:.5rem}
.preview-meta-row{display:flex;justify-content:space-between;font-size:.8rem}
.preview-meta-row .label{color:var(--text2);font-weight:500}
.preview-meta-row .value{font-weight:600}
.preview-actions{padding:1rem;border-top:1px solid var(--border);display:flex;gap:.4rem}

/* TOAST */
.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--nav);color:#fff;padding:.65rem 1rem;border-radius:10px;font-size:.82rem;z-index:300;display:none;box-shadow:0 4px 12px rgba(0,0,0,.2);max-width:380px}
.toast.show{display:block;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast.success{background:#065f46}.toast.error{background:#991b1b}

/* LAST UPDATED */
.last-updated-bar{position:fixed;bottom:0;right:0;background:rgba(15,23,42,.85);color:#94a3b8;font-size:.65rem;padding:4px 12px;border-radius:8px 0 0 0;z-index:90;backdrop-filter:blur(8px)}
.last-updated-bar strong{color:#60a5fa;font-weight:600}

/* AUTH */
.auth-overlay{position:fixed;inset:0;background:#0f172a;display:flex;align-items:center;justify-content:center;z-index:9999}
.auth-overlay.hidden{display:none}
.auth-box{background:rgba(30,41,59,.85);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:3rem 2.5rem;text-align:center;max-width:400px;width:90%}
.auth-title{font-size:1.75rem;color:#fff;font-weight:700}.auth-title span{color:#60a5fa}
.auth-sub{color:#94a3b8;font-size:.9rem;margin:.5rem 0 1.5rem}
.google-btn{display:inline-flex;align-items:center;gap:.6rem;background:#fff;border:none;border-radius:8px;padding:.7rem 1.5rem;font-size:.95rem;font-weight:600;cursor:pointer;font-family:inherit}
.google-btn:hover{background:#f1f5f9}
.auth-error{color:#ef4444;font-size:.85rem;margin-top:1rem;display:none}
.auth-domain{color:#64748b;font-size:.8rem;margin-top:1rem}

/* RESPONSIVE */
@media(max-width:768px){
  .hamburger{display:block}.nav-links{display:none}.nav-clocks{display:none}.today-badge{display:none}
  .app-layout{grid-template-columns:1fr}
  .sidebar{display:none}
  .file-list-header,.file-row{grid-template-columns:1fr 80px 50px}
  .file-entity,.file-category{display:none}
  .file-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .preview-panel{width:100%}
  .toggle-btn .label-text{display:none}
}
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
</head>
<body>

<!-- AUTH -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h1 class="auth-title">NF6 <span>Capital</span></h1>
    <p class="auth-sub" data-i18n="doc_auth_subtitle">Document Finder &mdash; Internal Use Only</p>
    <button class="google-btn" onclick="signInWithGoogle()" data-i18n="doc_auth_signin">
      <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <div class="auth-error" id="authError"></div>
    <p class="auth-domain" data-i18n="doc_auth_domain">Restricted to @nf6capital.com accounts</p>
  </div>
</div>

<!-- NAV -->
<nav>
  <a href="index.html" class="brand">NF6 <span>Capital</span></a>
  <div class="nav-links">
    <a href="index.html" data-i18n="nav_homebase">HomeBase</a>
    <a href="compliance-dashboard.html" data-i18n="nav_dashboard">Dashboard</a>
    <a href="compliance-calendar.html" data-i18n="nav_calendar">Calendar</a>
    <a href="audit-trail.html" data-i18n="nav_audit">Audit Trail</a>
    <a href="upload.html" data-i18n="nav_upload">Upload</a>
    <a href="document-finder.html" class="active" data-i18n="nav_docfinder">Documents</a>
  </div>
  <div class="nav-right">
    <button class="toggle-btn" onclick="toggleLang()" title="Switch language"><span class="icon">&#127760;</span> <span class="label-text" id="langLabel">ES</span></button>
    <button class="toggle-btn" onclick="toggleTheme()" title="Toggle dark/light mode"><span class="icon" id="themeIcon">&#9789;</span> <span class="label-text" id="themeLabel">Dark</span></button>
    <div class="nav-clocks">
      <div class="clock-circle"><span class="clock-label">COL</span><span class="clock-time" id="clockColombia">--:--</span></div>
      <div class="clock-circle"><span class="clock-label">PR</span><span class="clock-time" id="clockPR">--:--</span></div>
    </div>
    <div class="today-badge" id="todayBadge"></div>
    <button class="sign-out-btn" id="signOutBtn" onclick="signOutUser()" style="display:none">Sign Out</button>
  </div>
  <button class="hamburger" onclick="document.getElementById('mm').classList.toggle('open')">&#9776;</button>
</nav>
<div class="mobile-menu" id="mm">
  <a href="index.html">HomeBase</a>
  <a href="compliance-dashboard.html">Dashboard</a>
  <a href="compliance-calendar.html">Calendar</a>
  <a href="audit-trail.html">Audit Trail</a>
  <a href="upload.html">Upload</a>
  <a href="document-finder.html" class="active">Documents</a>
  <a href="#" onclick="signOutUser();return false">Sign Out</a>
</div>

<!-- MAIN APP -->
<div class="app-layout">

  <!-- SIDEBAR: Folder Tree -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title" data-i18n="doc_sidebar_folders">&#128193; Folders</div>
      <div class="sidebar-count" id="totalDocsCount">0 docs</div>
    </div>
    <div class="all-docs-btn active" onclick="showAllDocs()" data-i18n="doc_all_docs">&#128196; All Documents</div>
    <ul class="folder-tree" id="folderTree"></ul>
  </div>

  <!-- MAIN -->
  <div class="main-content">
    <!-- TOOLBAR -->
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search documents by name, entity, category..." oninput="filterDocs()" data-i18n="doc_search_placeholder">
      </div>
      <button class="toolbar-btn primary" onclick="openUploadModal()" data-i18n="doc_upload_btn">&#x2B06; Upload</button>
      <button class="toolbar-btn" onclick="exportIndex()" data-i18n="doc_export_csv">&#x2B07; Export Index</button>
      <div class="view-toggle">
        <button class="active" id="listViewBtn" onclick="setView('list')" title="List view">&#9776;</button>
        <button id="gridViewBtn" onclick="setView('grid')" title="Grid view">&#9638;</button>
      </div>
    </div>

    <!-- STATS -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-pill"><strong id="statTotal">0</strong>&nbsp;<span data-i18n="doc_stat_total">total</span></div>
      <div class="stat-pill"><strong id="statPdf">0</strong>&nbsp;<span data-i18n="doc_stat_pdfs">PDFs</span></div>
      <div class="stat-pill"><strong id="statRecent">0</strong>&nbsp;<span data-i18n="doc_stat_month">this month</span></div>
      <div class="stat-pill"><strong id="statSize">0 MB</strong>&nbsp;<span data-i18n="doc_stat_storage">stored</span></div>
    </div>

    <!-- BREADCRUMB -->
    <div class="breadcrumb" id="breadcrumb">
      <a onclick="showAllDocs()">All Documents</a>
    </div>

    <!-- FILE DISPLAY -->
    <div id="fileListView">
      <div class="file-list-header">
        <div data-i18n="doc_col_name">Name</div><div data-i18n="doc_col_entity">Entity</div><div data-i18n="doc_col_category">Category</div><div data-i18n="doc_col_date">Date</div><div></div>
      </div>
      <div id="fileListBody"></div>
    </div>
    <div id="fileGridView" style="display:none">
      <div class="file-grid" id="fileGridBody"></div>
    </div>

    <!-- EMPTY STATE -->
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="empty-icon">&#128194;</div>
      <h3 data-i18n="doc_empty_title">No documents yet</h3>
      <p data-i18n="doc_empty_desc">Upload your first document to get started. Files are auto-organized by entity and category.</p>
    </div>
  </div>
</div>

<!-- UPLOAD MODAL -->
<div class="modal-overlay" id="uploadModal">
  <div class="modal">
    <div class="modal-header">
      <h2 data-i18n="doc_modal_title">&#x2B06; Upload Documents</h2>
      <button class="modal-close" onclick="closeUploadModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="upload-zone" id="modalDropZone" onclick="document.getElementById('fileInput').click()">
        <div class="icon">&#128194;</div>
        <h3 data-i18n="doc_upload_drop">Drop files here or click to browse</h3>
        <p data-i18n="doc_upload_help">PDF, DOC, DOCX, XLS, XLSX, PNG, JPG &mdash; Max 25MB per file</p>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt,.csv" style="display:none">
      <div class="file-drop-list" id="fileDropList"></div>
      <div class="form-row">
        <div class="form-group">
          <label data-i18n="doc_form_entity">Entity</label>
          <select id="uploadEntity">
            <option value="" data-i18n="doc_select_entity">Select entity...</option>
            <option value="NF MDE CO">NF MDE CO</option>
            <option value="MN Personal">MN Personal</option>
            <option value="Paris Thacko">Paris Thacko</option>
            <option value="NF Texas">NF Texas</option>
            <option value="TLMND">TLMND</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="doc_form_category">Category</label>
          <select id="uploadCategory">
            <option value="" data-i18n="doc_select_category">Select category...</option>
            <option value="Tax" data-i18n="cat_tax">Tax</option>
            <option value="Legal" data-i18n="cat_legal">Legal</option>
            <option value="Insurance" data-i18n="cat_insurance">Insurance</option>
            <option value="Compliance" data-i18n="cat_compliance">Compliance</option>
            <option value="Banking" data-i18n="cat_banking">Banking</option>
            <option value="Contracts" data-i18n="cat_contracts">Contracts</option>
            <option value="Property" data-i18n="cat_property">Property</option>
            <option value="Maintenance" data-i18n="cat_maintenance">Maintenance</option>
            <option value="Govt/Permits" data-i18n="cat_govt">Govt/Permits</option>
            <option value="Other" data-i18n="cat_other">Other</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-i18n="doc_form_date">Document Date</label>
          <input type="date" id="uploadDate">
        </div>
        <div class="form-group">
          <label data-i18n="doc_form_name">Custom Name (optional)</label>
          <input type="text" id="uploadName" placeholder="Auto-generated if blank" data-i18n="doc_form_name_placeholder">
        </div>
      </div>
      <div class="form-group full" style="margin-top:.3rem">
        <label data-i18n="doc_form_notes">Notes (optional)</label>
        <input type="text" id="uploadNotes" placeholder="Brief description or notes..." data-i18n="doc_form_notes_placeholder">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeUploadModal()" data-i18n="doc_btn_cancel">Cancel</button>
      <button class="btn btn-primary" onclick="uploadFiles()" id="uploadBtn" data-i18n="doc_btn_upload">Upload &amp; Organize</button>
    </div>
  </div>
</div>

<!-- PREVIEW PANEL -->
<div class="preview-panel" id="previewPanel">
  <div class="preview-header">
    <h3 id="previewTitle" data-i18n="doc_preview_title">Document Details</h3>
    <button class="preview-close" onclick="closePreview()">&times;</button>
  </div>
  <div class="preview-body">
    <div class="preview-icon-large" id="previewIcon"></div>
    <div class="preview-meta" id="previewMeta"></div>
  </div>
  <div class="preview-actions" id="previewActions"></div>
</div>

<div class="last-updated-bar" id="lastUpdated"><span data-i18n="doc_last_updated">Last updated</span>: <strong>--</strong></div>
<div class="toast" id="toast"></div>

<script>
// ════════════════════════════════
// CONFIG
// ════════════════════════════════
const ENTITIES = ['NF MDE CO','MN Personal','Paris Thacko','NF Texas','TLMND'];
const CATEGORIES = ['Tax','Legal','Insurance','Compliance','Banking','Contracts','Property','Maintenance','Govt/Permits','Other'];
const CAT_ICONS = {Tax:'\u{1F4B0}',Legal:'\u2696\uFE0F',Insurance:'\u{1F6E1}\uFE0F',Compliance:'\u2705',Banking:'\u{1F3E6}',Contracts:'\u{1F4DD}',Property:'\u{1F3E0}',Maintenance:'\u{1F527}','Govt/Permits':'\u{1F3DB}\uFE0F',Other:'\u{1F4C1}'};
const CAT_BADGE = {Tax:'badge-tax',Legal:'badge-legal',Insurance:'badge-insurance',Compliance:'badge-compliance',Banking:'badge-banking',Contracts:'badge-contracts',Property:'badge-property',Maintenance:'badge-maintenance','Govt/Permits':'badge-govt',Other:'badge-other'};
const DOC_KEY = 'nf6_documents';
let documents = [];
let currentFilter = {entity:null,category:null};
let currentView = 'list';
let pendingFiles = [];

// ════════════════════════════════
// AUTH
// ════════════════════════════════
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAbvvj4qCzfZPdRxU6BtbRSfXDXPitNwkQ",
  authDomain:"nf6-compliance.firebaseapp.com",
  projectId:"nf6-compliance",
  storageBucket:"nf6-compliance.firebasestorage.app",
  messagingSenderId:"758076256010",
  appId:"1:758076256010:web:5799632950c369244c54f3"
};
let storageRef = null;
function initAuth() {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    storageRef = firebase.storage().ref();
    firebase.auth().onAuthStateChanged(user => {
      if(user) {
        if(user.email.split('@')[1] === 'nf6capital.com') {
          document.getElementById('authOverlay').classList.add('hidden');
          document.getElementById('signOutBtn').style.display = '';
        } else {
          document.getElementById('authError').textContent = 'Access restricted to @nf6capital.com';
          document.getElementById('authError').style.display = 'block';
          firebase.auth().signOut();
        }
      } else {
        document.getElementById('authOverlay').classList.remove('hidden');
        document.getElementById('signOutBtn').style.display = 'none';
      }
    });
  } catch(e) { console.warn('Firebase:', e.message); document.getElementById('authOverlay').classList.add('hidden'); }
}
function signInWithGoogle() {
  const p = new firebase.auth.GoogleAuthProvider();
  p.setCustomParameters({hd:'nf6capital.com'});
  firebase.auth().signInWithPopup(p).catch(e => {
    document.getElementById('authError').textContent = e.message;
    document.getElementById('authError').style.display = 'block';
  });
}
function signOutUser() { firebase.auth().signOut(); }

// ════════════════════════════════
// THEME + LANG
// ════════════════════════════════
const TRANSLATIONS={en:{nav_homebase:'HomeBase',nav_dashboard:'Dashboard',nav_calendar:'Calendar',nav_audit:'Audit Trail',nav_upload:'Upload',nav_docfinder:'Documents',doc_sidebar_folders:'Folders',doc_all_docs:'All Documents',doc_search_placeholder:'Search documents by name, entity, category...',doc_upload_btn:'Upload',doc_export_csv:'Export Index',doc_stat_total:'total',doc_stat_pdfs:'PDFs',doc_stat_month:'this month',doc_stat_storage:'stored',doc_col_name:'Name',doc_col_entity:'Entity',doc_col_category:'Category',doc_col_date:'Date',doc_empty_title:'No documents yet',doc_empty_desc:'Upload your first document to get started. Files are auto-organized by entity and category.',doc_modal_title:'Upload Documents',doc_upload_drop:'Drop files here or click to browse',doc_upload_help:'PDF, DOC, DOCX, XLS, XLSX, PNG, JPG — Max 25MB per file',doc_form_entity:'Entity',doc_select_entity:'Select entity...',doc_form_category:'Category',doc_select_category:'Select category...',doc_form_date:'Document Date',doc_form_name:'Custom Name (optional)',doc_form_name_placeholder:'Auto-generated if blank',doc_form_notes:'Notes (optional)',doc_form_notes_placeholder:'Brief description or notes...',doc_btn_cancel:'Cancel',doc_btn_upload:'Upload & Organize',doc_preview_title:'Document Details',doc_last_updated:'Last updated',doc_preview_orig_name:'Original Name',doc_preview_entity:'Entity',doc_preview_category:'Category',doc_preview_doc_date:'Document Date',doc_preview_file_size:'File Size',doc_preview_file_type:'File Type',doc_preview_uploaded:'Uploaded',doc_preview_uploaded_by:'Uploaded By',doc_preview_notes:'Notes',doc_preview_storage:'Storage Path',doc_btn_download:'Download',doc_btn_delete:'Delete',cat_tax:'Tax',cat_legal:'Legal',cat_insurance:'Insurance',cat_compliance:'Compliance',cat_banking:'Banking',cat_contracts:'Contracts',cat_property:'Property',cat_maintenance:'Maintenance',cat_govt:'Govt/Permits',cat_other:'Other',doc_toast_exceed:'exceeds 25MB limit',doc_toast_select_entity:'Please select an entity',doc_toast_select_category:'Please select a category',doc_toast_add_files:'Please add at least one file',doc_toast_uploading:'Uploading...',doc_toast_error_upload:'Error uploading',doc_toast_upload_success:'file(s) successfully!',doc_toast_no_download:'No download URL available. File may be stored locally only.',doc_toast_confirm_delete:'Delete',doc_toast_delete_confirm:'? This cannot be undone.',doc_toast_deleted:'Document deleted',doc_toast_exported:'Document index exported',doc_toast_no_export:'No documents to export',doc_docs_label:'docs',doc_auth_subtitle:'Document Finder — Internal Use Only',doc_auth_signin:'Sign in with Google',doc_auth_domain:'Restricted to @nf6capital.com accounts'},es:{nav_homebase:'Inicio',nav_dashboard:'Panel',nav_calendar:'Calendario',nav_audit:'Historial',nav_upload:'Cargar',nav_docfinder:'Documentos',doc_sidebar_folders:'Carpetas',doc_all_docs:'Todos los Documentos',doc_search_placeholder:'Buscar documentos por nombre, entidad, categoría...',doc_upload_btn:'Cargar',doc_export_csv:'Exportar Índice',doc_stat_total:'total',doc_stat_pdfs:'PDFs',doc_stat_month:'este mes',doc_stat_storage:'almacenado',doc_col_name:'Nombre',doc_col_entity:'Entidad',doc_col_category:'Categoría',doc_col_date:'Fecha',doc_empty_title:'Sin documentos aún',doc_empty_desc:'Cargue su primer documento para comenzar. Los archivos se organizan automáticamente por entidad y categoría.',doc_modal_title:'Cargar Documentos',doc_upload_drop:'Suelte los archivos aquí o haga clic para examinar',doc_upload_help:'PDF, DOC, DOCX, XLS, XLSX, PNG, JPG — Máximo 25MB por archivo',doc_form_entity:'Entidad',doc_select_entity:'Seleccionar entidad...',doc_form_category:'Categoría',doc_select_category:'Seleccionar categoría...',doc_form_date:'Fecha del Documento',doc_form_name:'Nombre Personalizado (opcional)',doc_form_name_placeholder:'Auto-generado si está en blanco',doc_form_notes:'Notas (opcional)',doc_form_notes_placeholder:'Descripción breve o notas...',doc_btn_cancel:'Cancelar',doc_btn_upload:'Cargar y Organizar',doc_preview_title:'Detalles del Documento',doc_last_updated:'Última actualización',doc_preview_orig_name:'Nombre Original',doc_preview_entity:'Entidad',doc_preview_category:'Categoría',doc_preview_doc_date:'Fecha del Documento',doc_preview_file_size:'Tamaño del Archivo',doc_preview_file_type:'Tipo de Archivo',doc_preview_uploaded:'Cargado',doc_preview_uploaded_by:'Cargado Por',doc_preview_notes:'Notas',doc_preview_storage:'Ruta de Almacenamiento',doc_btn_download:'Descargar',doc_btn_delete:'Eliminar',cat_tax:'Impuestos',cat_legal:'Legal',cat_insurance:'Seguros',cat_compliance:'Cumplimiento',cat_banking:'Banca',cat_contracts:'Contratos',cat_property:'Propiedad',cat_maintenance:'Mantenimiento',cat_govt:'Gobierno/Permisos',cat_other:'Otros',doc_toast_exceed:'excede límite de 25MB',doc_toast_select_entity:'Por favor seleccione una entidad',doc_toast_select_category:'Por favor seleccione una categoría',doc_toast_add_files:'Por favor agregue al menos un archivo',doc_toast_uploading:'Cargando...',doc_toast_error_upload:'Error al cargar',doc_toast_upload_success:'archivo(s) cargado(s) exitosamente!',doc_toast_no_download:'URL de descarga no disponible. El archivo puede estar almacenado solo localmente.',doc_toast_confirm_delete:'Eliminar',doc_toast_delete_confirm:'? No se puede deshacer.',doc_toast_deleted:'Documento eliminado',doc_toast_exported:'Índice de documentos exportado',doc_toast_no_export:'Sin documentos para exportar',doc_docs_label:'docs',doc_auth_subtitle:'Buscador de Documentos — Solo Uso Interno',doc_auth_signin:'Iniciar sesión con Google',doc_auth_domain:'Restringido a cuentas @nf6capital.com'}};
let currentLang=localStorage.getItem('nf6_lang')||'en';
let currentTheme=localStorage.getItem('nf6_theme')||'light';
function applyLang(lang){currentLang=lang;localStorage.setItem('nf6_lang',lang);document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(TRANSLATIONS[lang]&&TRANSLATIONS[lang][k])el.textContent=TRANSLATIONS[lang][k];});const lb=document.getElementById('langLabel');if(lb)lb.textContent=lang==='en'?'ES':'EN';}
function toggleLang(){applyLang(currentLang==='en'?'es':'en');}
function applyTheme(theme){currentTheme=theme;localStorage.setItem('nf6_theme',theme);document.documentElement.setAttribute('data-theme',theme);const isDark=theme==='dark';const ti=document.getElementById('themeIcon');if(ti)ti.innerHTML=isDark?'&#9788;':'&#9789;';const tl=document.getElementById('themeLabel');if(tl)tl.textContent=isDark?'Light':'Dark';}
function toggleTheme(){applyTheme(currentTheme==='light'?'dark':'light');}

// ════════════════════════════════
// CLOCKS
// ════════════════════════════════
function updateClocks(){const now=new Date();const fmt=(tz)=>now.toLocaleTimeString('en-US',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});const col=document.getElementById('clockColombia');const pr=document.getElementById('clockPR');if(col)col.textContent=fmt('America/Bogota');if(pr)pr.textContent=fmt('America/Puerto_Rico');}
setInterval(updateClocks,1000);updateClocks();
function updateTodayBadge(){const el=document.getElementById('todayBadge');if(el)el.textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});}
updateTodayBadge();
function updateLastUpdated(){const el=document.getElementById('lastUpdated');if(el){const lastUpdatedLabel=TRANSLATIONS[currentLang]&&TRANSLATIONS[currentLang]['doc_last_updated']?TRANSLATIONS[currentLang]['doc_last_updated']:'Last updated';el.innerHTML=lastUpdatedLabel+': <strong>'+new Date().toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true})+'</strong>';}}
updateLastUpdated();setInterval(updateLastUpdated,60000);

// ════════════════════════════════
// DOCUMENT STORAGE (localStorage + Firebase Storage for files)
// ════════════════════════════════
function loadDocs() {
  try { const s = localStorage.getItem(DOC_KEY); if(s) documents = JSON.parse(s); } catch(e){}
  renderAll();
}
function saveDocs() {
  localStorage.setItem(DOC_KEY, JSON.stringify(documents));
}

function getFileIcon(name) {
  const ext = name.split('.').pop().toLowerCase();
  const icons = {pdf:'\u{1F4C4}',doc:'\u{1F4DD}',docx:'\u{1F4DD}',xls:'\u{1F4CA}',xlsx:'\u{1F4CA}',csv:'\u{1F4CA}',png:'\u{1F5BC}\uFE0F',jpg:'\u{1F5BC}\uFE0F',jpeg:'\u{1F5BC}\uFE0F',txt:'\u{1F4C3}'};
  return icons[ext] || '\u{1F4C1}';
}

function formatSize(bytes) {
  if(bytes < 1024) return bytes + ' B';
  if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1048576).toFixed(1) + ' MB';
}

function generateFileName(originalName, entity, category, dateStr) {
  const ext = originalName.split('.').pop();
  const baseName = originalName.replace(/\.[^.]+$/, '').replace(/[^a-zA-Z0-9\-_]/g, '-').substring(0, 40);
  const entitySlug = entity.replace(/\s+/g, '-');
  const catSlug = category.replace(/[\/]/g, '-');
  return dateStr + '_' + entitySlug + '_' + catSlug + '_' + baseName + '.' + ext;
}

// ════════════════════════════════
// FOLDER TREE
// ════════════════════════════════
function getCategoryLabel(cat) {
  const key = 'cat_' + cat.toLowerCase().replace('/','_').replace(/ /g,'_');
  if(TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) {
    return TRANSLATIONS[currentLang][key];
  }
  return cat;
}
function buildFolderTree() {
  const tree = document.getElementById('folderTree');
  tree.innerHTML = '';
  ENTITIES.forEach(entity => {
    const entityDocs = documents.filter(d => d.entity === entity);
    const li = document.createElement('li');
    li.className = 'folder-entity';
    li.innerHTML = `
      <div class="folder-entity-header" onclick="toggleEntity(this)">
        <span class="arrow">&#9654;</span>
        <span class="entity-icon">\u{1F4C1}</span>
        <span class="entity-name">${entity}</span>
        <span class="entity-count">${entityDocs.length}</span>
      </div>
      <ul class="folder-categories" id="cats_${entity.replace(/\s/g,'_')}">
        ${CATEGORIES.map(cat => {
          const count = entityDocs.filter(d => d.category === cat).length;
          if(count === 0) return '';
          return `<li class="folder-cat-item" onclick="filterByFolder('${entity}','${cat}')" data-entity="${entity}" data-cat="${cat}">
            <span class="cat-icon">${CAT_ICONS[cat]||'\u{1F4C1}'}</span>
            ${getCategoryLabel(cat)}
            <span class="cat-count">${count}</span>
          </li>`;
        }).join('')}
      </ul>`;
    tree.appendChild(li);
  });
  const docsLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_docs_label'] ? TRANSLATIONS[currentLang]['doc_docs_label'] : 'docs';
  document.getElementById('totalDocsCount').textContent = documents.length + ' ' + docsLabel;
}

function toggleEntity(header) {
  const arrow = header.querySelector('.arrow');
  const cats = header.nextElementSibling;
  arrow.classList.toggle('open');
  cats.classList.toggle('open');
}

function filterByFolder(entity, category) {
  currentFilter = {entity, category};
  document.querySelectorAll('.folder-cat-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.all-docs-btn').forEach(el => el.classList.remove('active'));
  const target = document.querySelector(`.folder-cat-item[data-entity="${entity}"][data-cat="${category}"]`);
  if(target) target.classList.add('active');
  updateBreadcrumb();
  renderFileList();
}

function showAllDocs() {
  currentFilter = {entity:null, category:null};
  document.querySelectorAll('.folder-cat-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.all-docs-btn').forEach(el => el.classList.add('active'));
  updateBreadcrumb();
  renderFileList();
}

function updateBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  const allDocsLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_all_docs'] ? TRANSLATIONS[currentLang]['doc_all_docs'] : 'All Documents';
  let html = '<a onclick="showAllDocs()">'+allDocsLabel+'</a>';
  if(currentFilter.entity) {
    html += ' <span class="sep">/</span> <a onclick="filterByFolder(\''+currentFilter.entity+'\',null)">' + currentFilter.entity + '</a>';
  }
  if(currentFilter.category) {
    html += ' <span class="sep">/</span> <span>' + getCategoryLabel(currentFilter.category) + '</span>';
  }
  bc.innerHTML = html;
}

// ════════════════════════════════
// FILE LIST RENDERING
// ════════════════════════════════
function getFilteredDocs() {
  let filtered = [...documents];
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  if(q) {
    filtered = filtered.filter(d =>
      d.displayName.toLowerCase().includes(q) ||
      d.originalName.toLowerCase().includes(q) ||
      d.entity.toLowerCase().includes(q) ||
      d.category.toLowerCase().includes(q) ||
      (d.notes||'').toLowerCase().includes(q)
    );
  }
  if(currentFilter.entity) filtered = filtered.filter(d => d.entity === currentFilter.entity);
  if(currentFilter.category) filtered = filtered.filter(d => d.category === currentFilter.category);
  return filtered.sort((a,b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
}

function renderFileList() {
  const filtered = getFilteredDocs();
  const listBody = document.getElementById('fileListBody');
  const gridBody = document.getElementById('fileGridBody');
  const empty = document.getElementById('emptyState');

  if(filtered.length === 0) {
    empty.style.display = 'block';
    listBody.innerHTML = '';
    gridBody.innerHTML = '';
    return;
  }
  empty.style.display = 'none';

  // List view
  listBody.innerHTML = filtered.map((doc, i) => `
    <div class="file-row" onclick="openPreview(${documents.indexOf(doc)})">
      <div class="file-name">
        <span class="file-icon">${getFileIcon(doc.originalName)}</span>
        <div class="file-info">
          <div class="name">${doc.displayName}</div>
          <div class="path">${doc.entity} / ${getCategoryLabel(doc.category)}</div>
        </div>
      </div>
      <div class="file-entity"><span class="badge ${CAT_BADGE[doc.category]||'badge-other'}">${doc.entity}</span></div>
      <div class="file-category"><span class="badge ${CAT_BADGE[doc.category]||'badge-other'}">${getCategoryLabel(doc.category)}</span></div>
      <div class="file-date">${doc.docDate || '--'}</div>
      <div class="file-actions">
        <button class="file-action-btn" onclick="event.stopPropagation();downloadDoc(${documents.indexOf(doc)})" title="Download">&#x2B07;</button>
        <button class="file-action-btn delete" onclick="event.stopPropagation();deleteDoc(${documents.indexOf(doc)})" title="Delete">&times;</button>
      </div>
    </div>
  `).join('');

  // Grid view
  gridBody.innerHTML = filtered.map((doc, i) => `
    <div class="file-grid-card" onclick="openPreview(${documents.indexOf(doc)})">
      <div class="file-grid-icon">${getFileIcon(doc.originalName)}</div>
      <div class="file-grid-name">${doc.displayName}</div>
      <div class="file-grid-meta">${doc.entity} &middot; ${getCategoryLabel(doc.category)}</div>
      <div class="file-grid-meta">${doc.docDate || ''} &middot; ${formatSize(doc.size||0)}</div>
    </div>
  `).join('');

  updateStats(filtered);
}

function filterDocs() { renderFileList(); }

function updateStats(filtered) {
  const all = documents;
  document.getElementById('statTotal').textContent = all.length;
  document.getElementById('statPdf').textContent = all.filter(d => d.originalName.toLowerCase().endsWith('.pdf')).length;
  const thisMonth = new Date(); thisMonth.setDate(1); thisMonth.setHours(0,0,0,0);
  document.getElementById('statRecent').textContent = all.filter(d => new Date(d.uploadedAt) >= thisMonth).length;
  const totalSize = all.reduce((sum, d) => sum + (d.size||0), 0);
  document.getElementById('statSize').textContent = formatSize(totalSize);
}

function setView(view) {
  currentView = view;
  document.getElementById('fileListView').style.display = view === 'list' ? 'block' : 'none';
  document.getElementById('fileGridView').style.display = view === 'grid' ? 'block' : 'none';
  document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
  document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
}

// ════════════════════════════════
// UPLOAD
// ════════════════════════════════
function openUploadModal() {
  pendingFiles = [];
  document.getElementById('fileDropList').innerHTML = '';
  document.getElementById('uploadEntity').value = '';
  document.getElementById('uploadCategory').value = '';
  document.getElementById('uploadDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('uploadName').value = '';
  document.getElementById('uploadNotes').value = '';
  document.getElementById('uploadModal').classList.add('open');
}
function closeUploadModal() { document.getElementById('uploadModal').classList.remove('open'); }

// Drag & drop for modal
const modalDrop = document.getElementById('modalDropZone');
['dragenter','dragover'].forEach(e => modalDrop.addEventListener(e, ev => { ev.preventDefault(); modalDrop.classList.add('drag-over'); }));
['dragleave','drop'].forEach(e => modalDrop.addEventListener(e, ev => { ev.preventDefault(); modalDrop.classList.remove('drag-over'); }));
modalDrop.addEventListener('drop', ev => { addPendingFiles(ev.dataTransfer.files); });
document.getElementById('fileInput').addEventListener('change', ev => { addPendingFiles(ev.target.files); ev.target.value=''; });

function addPendingFiles(fileList) {
  const exceedMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_exceed'] ? TRANSLATIONS[currentLang]['doc_toast_exceed'] : 'exceeds 25MB limit';
  for(let f of fileList) {
    if(f.size > 25*1024*1024) { showToast(f.name + ' ' + exceedMsg,'error'); continue; }
    pendingFiles.push(f);
  }
  renderPendingFiles();
}

function renderPendingFiles() {
  const list = document.getElementById('fileDropList');
  list.innerHTML = pendingFiles.map((f,i) => `
    <div class="file-drop-item">
      <span class="fdi-icon">${getFileIcon(f.name)}</span>
      <span class="fdi-name">${f.name}</span>
      <span class="fdi-size">${formatSize(f.size)}</span>
      <button class="fdi-remove" onclick="removePendingFile(${i})">&times;</button>
    </div>
  `).join('');
}

function removePendingFile(i) { pendingFiles.splice(i,1); renderPendingFiles(); }

async function uploadFiles() {
  const entity = document.getElementById('uploadEntity').value;
  const category = document.getElementById('uploadCategory').value;
  const dateStr = document.getElementById('uploadDate').value;
  const customName = document.getElementById('uploadName').value.trim();
  const notes = document.getElementById('uploadNotes').value.trim();

  const selectEntityMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_select_entity'] ? TRANSLATIONS[currentLang]['doc_toast_select_entity'] : 'Please select an entity';
  const selectCategoryMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_select_category'] ? TRANSLATIONS[currentLang]['doc_toast_select_category'] : 'Please select a category';
  const addFilesMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_add_files'] ? TRANSLATIONS[currentLang]['doc_toast_add_files'] : 'Please add at least one file';
  const uploadingMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_uploading'] ? TRANSLATIONS[currentLang]['doc_toast_uploading'] : 'Uploading...';

  if(!entity) { showToast(selectEntityMsg,'error'); return; }
  if(!category) { showToast(selectCategoryMsg,'error'); return; }
  if(!pendingFiles.length) { showToast(addFilesMsg,'error'); return; }

  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.textContent = uploadingMsg;

  for(const file of pendingFiles) {
    try {
      const displayName = customName || generateFileName(file.name, entity, category, dateStr);
      const storagePath = 'documents/' + entity.replace(/\s/g,'_') + '/' + category.replace(/[\/]/g,'-') + '/' + displayName;

      // Upload to Firebase Storage
      let downloadURL = '';
      try {
        if(storageRef) {
          const snap = await storageRef.child(storagePath).put(file);
          downloadURL = await snap.ref.getDownloadURL();
        }
      } catch(e) {
        console.warn('Firebase Storage upload failed, saving metadata only:', e.message);
      }

      // Save metadata locally
      const docRecord = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2,6),
        originalName: file.name,
        displayName: displayName,
        entity: entity,
        category: category,
        docDate: dateStr,
        notes: notes,
        size: file.size,
        type: file.type,
        storagePath: storagePath,
        downloadURL: downloadURL,
        uploadedAt: new Date().toISOString(),
        uploadedBy: firebase.auth().currentUser ? firebase.auth().currentUser.email : 'unknown'
      };
      documents.push(docRecord);
    } catch(e) {
      const errorMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_error_upload'] ? TRANSLATIONS[currentLang]['doc_toast_error_upload'] : 'Error uploading';
      showToast(errorMsg + ' ' + file.name + ': ' + e.message, 'error');
    }
  }

  saveDocs();
  renderAll();
  closeUploadModal();
  btn.disabled = false;
  const uploadBtnText = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_btn_upload'] ? TRANSLATIONS[currentLang]['doc_btn_upload'] : 'Upload & Organize';
  btn.textContent = uploadBtnText;
  const successMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_upload_success'] ? 'Uploaded ' + pendingFiles.length + ' ' + TRANSLATIONS[currentLang]['doc_toast_upload_success'] : 'Uploaded ' + pendingFiles.length + ' file(s) successfully!';
  showToast(successMsg, 'success');
}

// ════════════════════════════════
// ACTIONS
// ════════════════════════════════
function downloadDoc(idx) {
  const doc = documents[idx];
  if(doc.downloadURL) {
    window.open(doc.downloadURL, '_blank');
  } else {
    const noDownloadMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_no_download'] ? TRANSLATIONS[currentLang]['doc_toast_no_download'] : 'No download URL available. File may be stored locally only.';
    showToast(noDownloadMsg, 'error');
  }
}

function deleteDoc(idx) {
  const deleteMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_confirm_delete'] ? TRANSLATIONS[currentLang]['doc_toast_confirm_delete'] : 'Delete';
  const deleteConfirmMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_delete_confirm'] ? TRANSLATIONS[currentLang]['doc_toast_delete_confirm'] : '? This cannot be undone.';
  const deletedMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_deleted'] ? TRANSLATIONS[currentLang]['doc_toast_deleted'] : 'Document deleted';

  if(!confirm(deleteMsg + ' "' + documents[idx].displayName + '"' + deleteConfirmMsg)) return;
  const doc = documents[idx];
  // Try to delete from Firebase Storage
  if(storageRef && doc.storagePath) {
    storageRef.child(doc.storagePath).delete().catch(e => console.warn('Storage delete:', e.message));
  }
  documents.splice(idx, 1);
  saveDocs();
  renderAll();
  closePreview();
  showToast(deletedMsg, 'success');
}

function openPreview(idx) {
  const doc = documents[idx];
  const panel = document.getElementById('previewPanel');
  document.getElementById('previewTitle').textContent = doc.displayName;
  document.getElementById('previewIcon').textContent = getFileIcon(doc.originalName);

  const origNameLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_orig_name'] ? TRANSLATIONS[currentLang]['doc_preview_orig_name'] : 'Original Name';
  const entityLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_entity'] ? TRANSLATIONS[currentLang]['doc_preview_entity'] : 'Entity';
  const categoryLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_category'] ? TRANSLATIONS[currentLang]['doc_preview_category'] : 'Category';
  const docDateLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_doc_date'] ? TRANSLATIONS[currentLang]['doc_preview_doc_date'] : 'Document Date';
  const fileSizeLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_file_size'] ? TRANSLATIONS[currentLang]['doc_preview_file_size'] : 'File Size';
  const fileTypeLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_file_type'] ? TRANSLATIONS[currentLang]['doc_preview_file_type'] : 'File Type';
  const uploadedLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_uploaded'] ? TRANSLATIONS[currentLang]['doc_preview_uploaded'] : 'Uploaded';
  const uploadedByLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_uploaded_by'] ? TRANSLATIONS[currentLang]['doc_preview_uploaded_by'] : 'Uploaded By';
  const notesLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_notes'] ? TRANSLATIONS[currentLang]['doc_preview_notes'] : 'Notes';
  const storageLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_preview_storage'] ? TRANSLATIONS[currentLang]['doc_preview_storage'] : 'Storage Path';

  document.getElementById('previewMeta').innerHTML = `
    <div class="preview-meta-row"><span class="label">${origNameLabel}</span><span class="value">${doc.originalName}</span></div>
    <div class="preview-meta-row"><span class="label">${entityLabel}</span><span class="value">${doc.entity}</span></div>
    <div class="preview-meta-row"><span class="label">${categoryLabel}</span><span class="value"><span class="badge ${CAT_BADGE[doc.category]||'badge-other'}">${getCategoryLabel(doc.category)}</span></span></div>
    <div class="preview-meta-row"><span class="label">${docDateLabel}</span><span class="value">${doc.docDate || '--'}</span></div>
    <div class="preview-meta-row"><span class="label">${fileSizeLabel}</span><span class="value">${formatSize(doc.size||0)}</span></div>
    <div class="preview-meta-row"><span class="label">${fileTypeLabel}</span><span class="value">${doc.type || 'Unknown'}</span></div>
    <div class="preview-meta-row"><span class="label">${uploadedLabel}</span><span class="value">${new Date(doc.uploadedAt).toLocaleString()}</span></div>
    <div class="preview-meta-row"><span class="label">${uploadedByLabel}</span><span class="value">${doc.uploadedBy || '--'}</span></div>
    ${doc.notes ? '<div class="preview-meta-row"><span class="label">'+notesLabel+'</span><span class="value">'+doc.notes+'</span></div>' : ''}
    <div class="preview-meta-row"><span class="label">${storageLabel}</span><span class="value" style="font-size:.7rem;word-break:break-all">${doc.storagePath || '--'}</span></div>
  `;

  const downloadBtnLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_btn_download'] ? TRANSLATIONS[currentLang]['doc_btn_download'] : 'Download';
  const deleteBtnLabel = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_btn_delete'] ? TRANSLATIONS[currentLang]['doc_btn_delete'] : 'Delete';

  document.getElementById('previewActions').innerHTML = `
    <button class="btn btn-primary" style="flex:1" onclick="downloadDoc(${idx})">&#x2B07; ${downloadBtnLabel}</button>
    <button class="btn btn-danger" onclick="deleteDoc(${idx})">&#x1F5D1; ${deleteBtnLabel}</button>
  `;
  panel.classList.add('open');
}
function closePreview() { document.getElementById('previewPanel').classList.remove('open'); }

function exportIndex() {
  const noExportMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_no_export'] ? TRANSLATIONS[currentLang]['doc_toast_no_export'] : 'No documents to export';
  const exportedMsg = TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang]['doc_toast_exported'] ? TRANSLATIONS[currentLang]['doc_toast_exported'] : 'Document index exported';

  if(!documents.length) { showToast(noExportMsg,'error'); return; }
  const header = 'Display Name,Original Name,Entity,Category,Date,Size,Notes,Uploaded At,Uploaded By,Storage Path\n';
  const rows = documents.map(d => [d.displayName,d.originalName,d.entity,d.category,d.docDate,d.size,d.notes||'',d.uploadedAt,d.uploadedBy||'',d.storagePath||''].map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([header+rows],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'nf6_document_index_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
  showToast(exportedMsg,'success');
}

// ════════════════════════════════
// RENDER ALL
// ════════════════════════════════
function renderAll() {
  buildFolderTree();
  renderFileList();
}

// ════════════════════════════════
// TOAST
// ════════════════════════════════
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' '+type : '');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(() => t.className = 'toast', 3500);
}

// ════════════════════════════════
// INIT
// ════════════════════════════════
initAuth();
applyTheme(currentTheme);
applyLang(currentLang);
loadDocs();
</script>
</body>
</html>
