<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NF6 Capital — Compliance Calendar</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #f5f7fa;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1a202c;
    --text-secondary: #64748b;
    --accent: #2563eb;
    --accent-light: #eff6ff;
    --green: #16a34a;
    --green-bg: #f0fdf4;
    --yellow: #ca8a04;
    --yellow-bg: #fefce8;
    --red: #dc2626;
    --red-bg: #fef2f2;
    --orange: #ea580c;
    --orange-bg: #fff7ed;
    --purple: #7c3aed;
    --purple-bg: #f5f3ff;
    --gray: #64748b;
    --gray-bg: #f8fafc;
  }

  [data-theme="dark"] {
    --bg:#0f172a;--card:#1e293b;--border:#334155;--text:#1a202c;--text-secondary:#94a3b8;
    --accent:#60a5fa;--accent-light:#1e3a5f;--green:#4ade80;--green-bg:#064e3b;
    --yellow:#fbbf24;--yellow-bg:#713f12;--red:#f87171;--red-bg:#7f1d1d;
    --orange:#fb923c;--orange-bg:#7c2d12;--purple:#a78bfa;--purple-bg:#4c1d95;
    --gray:#94a3b8;--gray-bg:#0f172a;
  }
  [data-theme="dark"] body { color: #e2e8f0; }
  [data-theme="dark"] .cal-controls button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  [data-theme="dark"] .cal-controls button:hover { background: #334155; }
  [data-theme="dark"] .cal-grid .day-header { background: #1e293b; color: #94a3b8; }
  [data-theme="dark"] .cal-grid .day-cell { background: #1e293b; border-color: #334155; }
  [data-theme="dark"] .cal-grid .day-cell:hover { background: #334155; }
  [data-theme="dark"] .cal-grid .day-cell.today { border-color: #60a5fa; }
  [data-theme="dark"] .page-header h1, [data-theme="dark"] .sidebar-title { color: #e2e8f0; }
  [data-theme="dark"] .edit-field input, [data-theme="dark"] .edit-field select { background: #0f172a; color: #e2e8f0; border-color: #334155; }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    transition: background .3s, color .3s;
  }

  /* NAV */
  nav {
    background: #0f172a;
    color: #fff;
    padding: 0 2rem;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  nav .brand { font-weight: 700; font-size: 1.15rem; letter-spacing: -.02em; }
  nav .brand span { color: #60a5fa; }
  nav .nav-links { display: flex; gap: 1.5rem; }
  nav .nav-links a { color: #94a3b8; text-decoration: none; font-size: .875rem; font-weight: 500; transition: color .2s; }
  nav .nav-links a:hover, nav .nav-links a.active { color: #fff; }
  .today-badge { background: #1e3a5f; color: #93c5fd; font-size: .75rem; padding: 4px 10px; border-radius: 6px; font-weight: 500; }

  /* HEADER */
  .page-header {
    padding: 1.5rem 2rem 0;
    max-width: 1600px;
    margin: 0 auto;
  }
  .page-header h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: -.03em; }
  .page-header p { color: var(--text-secondary); margin-top: .25rem; font-size: .925rem; }

  /* MAIN 2-COLUMN LAYOUT */
  .main-layout {
    display: grid;
    grid-template-columns: 1fr 370px;
    gap: 1.5rem;
    max-width: 1600px;
    margin: 0 auto;
    padding: 1rem 2rem 2rem;
    align-items: start;
  }

  .calendar-col { min-width: 0; }

  /* SIDEBAR */
  .sidebar {
    position: sticky;
    top: 72px;
    max-height: calc(100vh - 88px);
    display: flex;
    flex-direction: column;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    background: var(--gray-bg);
  }
  .sidebar-title {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: .75rem;
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  /* LIVE CLOCKS */
  .live-clocks {
    display: flex;
    gap: .75rem;
    justify-content: center;
  }
  .clock-circle {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, #1e293b, #0f172a);
    border: 2px solid #334155;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 12px rgba(96,165,250,.15), inset 0 1px 3px rgba(0,0,0,.3);
    position: relative;
    overflow: hidden;
  }
  .clock-circle::before {
    content: '';
    position: absolute;
    top: -1px; left: -1px; right: -1px; bottom: -1px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, #60a5fa 0%, #3b82f6 25%, #1e40af 50%, #3b82f6 75%, #60a5fa 100%);
    opacity: .15;
    z-index: 0;
  }
  .clock-label {
    font-size: .5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: #94a3b8;
    z-index: 1;
    line-height: 1;
  }
  .clock-time {
    font-family: 'Courier New', monospace;
    font-size: .7rem;
    font-weight: 700;
    color: #60a5fa;
    z-index: 1;
    line-height: 1.3;
    letter-spacing: .02em;
  }

  /* SIDEBAR ITEMS */
  .sidebar-body {
    flex: 1;
    overflow-y: auto;
    padding: .5rem;
  }
  .sidebar-body::-webkit-scrollbar { width: 5px; }
  .sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .sidebar-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
    font-size: .875rem;
  }

  .sb-card {
    padding: .75rem .85rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-bottom: .5rem;
    cursor: pointer;
    transition: all .2s;
    position: relative;
  }
  .sb-card:hover { background: var(--accent-light); border-color: var(--accent); }
  .sb-card .sb-top { display: flex; gap: .5rem; align-items: flex-start; }
  .sb-card .dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
  .sb-card .sb-info { flex: 1; min-width: 0; }
  .sb-card .sb-title { font-weight: 600; font-size: .82rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sb-card .sb-meta { font-size: .72rem; color: var(--text-secondary); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sb-card .sb-due { font-size: .72rem; font-weight: 600; margin-top: 3px; }
  .sb-card .sb-edit-icon {
    position: absolute;
    top: .5rem;
    right: .5rem;
    font-size: .7rem;
    color: var(--accent);
    opacity: 0;
    transition: opacity .2s;
  }
  .sb-card:hover .sb-edit-icon { opacity: 1; }

  .dot.critical { background: var(--red); }
  .dot.warning { background: var(--orange); }
  .dot.notice { background: var(--yellow); }
  .dot.none { background: var(--green); }
  .dot.notstarted { background: var(--purple); }

  /* EDIT PANEL (inline in sidebar) */
  .edit-panel {
    display: none;
    padding: 1rem;
    border-top: 1px solid var(--border);
    background: var(--gray-bg);
  }
  .edit-panel.active { display: block; }
  .edit-panel h3 {
    font-size: .85rem;
    font-weight: 700;
    margin-bottom: .75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .edit-panel .close-edit {
    background: none;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0 4px;
  }
  .edit-panel .close-edit:hover { color: var(--red); }
  .edit-field {
    margin-bottom: .6rem;
  }
  .edit-field label {
    display: block;
    font-size: .72rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: .04em;
    margin-bottom: 3px;
  }
  .edit-field input, .edit-field select {
    width: 100%;
    padding: .4rem .6rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: .82rem;
    font-family: inherit;
    background: var(--card);
  }
  .edit-field input:focus, .edit-field select:focus { outline: none; border-color: var(--accent); }
  .edit-actions {
    display: flex;
    gap: .5rem;
    margin-top: .75rem;
  }
  .edit-actions button {
    flex: 1;
    padding: .45rem;
    border-radius: 6px;
    font-size: .8rem;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: all .2s;
  }
  .btn-save { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-save:hover { background: #1d4ed8; }
  .btn-cancel { background: var(--card); }
  .btn-cancel:hover { background: var(--gray-bg); }

  /* CALENDAR CONTROLS */
  .cal-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    padding: .75rem 0 .75rem;
  }
  .cal-controls .month-label {
    font-size: 1.25rem;
    font-weight: 700;
    min-width: 200px;
    text-align: center;
  }
  .cal-controls button {
    padding: .45rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    font-size: .82rem;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    color: var(--text);
  }
  .cal-controls button:hover { border-color: var(--accent); color: var(--accent); }
  .cal-controls .today-btn { background: var(--accent); color: #fff; border-color: var(--accent); }
  .cal-controls .today-btn:hover { background: #1d4ed8; }

  /* FILTER ROW */
  .filter-row {
    display: flex;
    gap: .5rem;
    padding: 0 0 .75rem;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
  }
  .filter-row select {
    padding: .4rem .65rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    font-size: .78rem;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    outline: none;
  }

  /* CALENDAR GRID */
  .cal-grid {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .cal-header-row {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f8fafc;
    border-bottom: 1px solid var(--border);
  }
  .cal-header-row .day-label {
    text-align: center;
    padding: .55rem .5rem;
    font-size: .72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: var(--text-secondary);
  }
  .cal-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
  }
  .cal-cell {
    min-height: 100px;
    border-right: 1px solid #f1f5f9;
    border-bottom: 1px solid #f1f5f9;
    padding: .3rem .4rem;
    position: relative;
    transition: background .15s;
  }
  .cal-cell:nth-child(7n) { border-right: none; }
  .cal-cell:hover { background: #fafbfd; }
  .cal-cell.outside { background: #fafbfc; opacity: .45; }
  .cal-cell.today { background: var(--accent-light); }
  .cal-cell.today .date-num { color: var(--accent); font-weight: 700; }
  .date-num {
    font-size: .78rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }
  .cal-event {
    display: block;
    padding: 2px 5px;
    border-radius: 4px;
    font-size: .62rem;
    font-weight: 600;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    line-height: 1.4;
    transition: opacity .15s;
  }
  .cal-event:hover { opacity: .85; }
  .cal-event.urgency-overdue { background: var(--red-bg); color: var(--red); border-left: 3px solid var(--red); }
  .cal-event.urgency-critical { background: var(--red-bg); color: var(--red); border-left: 3px solid var(--red); }
  .cal-event.urgency-warning { background: var(--orange-bg); color: var(--orange); border-left: 3px solid var(--orange); }
  .cal-event.urgency-notice { background: var(--yellow-bg); color: var(--yellow); border-left: 3px solid var(--yellow); }
  .cal-event.urgency-none { background: var(--green-bg); color: var(--green); border-left: 3px solid var(--green); }
  .cal-event.urgency-notstarted { background: var(--purple-bg); color: var(--purple); border-left: 3px solid var(--purple); }
  .cal-more {
    font-size: .62rem;
    color: var(--accent);
    font-weight: 600;
    padding: 1px 5px;
    cursor: pointer;
  }
  .cal-more:hover { text-decoration: underline; }

  /* TOOLTIP */
  .tooltip {
    display: none;
    position: fixed;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    width: 320px;
    box-shadow: 0 8px 24px rgba(0,0,0,.12);
    z-index: 200;
    font-size: .82rem;
  }
  .tooltip.show { display: block; }
  .tooltip .tt-title { font-weight: 700; font-size: .9rem; margin-bottom: .5rem; }
  .tooltip .tt-row { display: flex; gap: .5rem; margin-bottom: .25rem; }
  .tooltip .tt-label { font-weight: 600; color: var(--text-secondary); min-width: 80px; }
  .tooltip .tt-val { flex: 1; }
  .badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 9999px;
    font-size: .72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    white-space: nowrap;
  }
  .badge-green { background: var(--green-bg); color: var(--green); }
  .badge-red { background: var(--red-bg); color: var(--red); }
  .badge-orange { background: var(--orange-bg); color: var(--orange); }
  .badge-yellow { background: var(--yellow-bg); color: var(--yellow); }
  .badge-purple { background: var(--purple-bg); color: var(--purple); }
  .badge-blue { background: var(--accent-light); color: var(--accent); }

  /* RESPONSIVE */
  @media (max-width: 1100px) {
    .main-layout { grid-template-columns: 1fr; }
    .sidebar { position: static; max-height: none; }
  }
  @media (max-width: 900px) {
    .cal-cell { min-height: 75px; }
    .cal-event { font-size: .58rem; }
  }
  @media (max-width: 600px) {
    .cal-controls { gap: .75rem; }
    .cal-controls .month-label { font-size: 1.05rem; min-width: 150px; }
    .main-layout { padding: .75rem 1rem 1.5rem; }
    .live-clocks { flex-direction: column; }
    .toggle-btn .label-text { display: none; }
  }

  /* NAV CLOCKS */
  .nav-clocks { display: flex; gap: .5rem; align-items: center; }
  .nav-clock-circle { width: 52px; height: 52px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #1e293b, #0f172a); border: 2px solid #334155; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(96,165,250,.12), inset 0 1px 2px rgba(0,0,0,.3); position: relative; overflow: hidden; }
  .nav-clock-circle::before { content: ''; position: absolute; top: -1px; left: -1px; right: -1px; bottom: -1px; border-radius: 50%; background: conic-gradient(from 0deg, #60a5fa 0%, #3b82f6 25%, #1e40af 50%, #3b82f6 75%, #60a5fa 100%); opacity: .15; z-index: 0; }
  .nav-clock-circle .clock-label { font-size: .42rem; z-index: 1; }
  .nav-clock-circle .clock-time { font-size: .6rem; z-index: 1; }

  .toggle-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#94a3b8;padding:.3rem .55rem;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;white-space:nowrap;display:flex;align-items:center;gap:.25rem}
  .toggle-btn:hover{color:#fff;background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.2)}
  .toggle-btn .icon{font-size:.8rem}

  /* LAST UPDATED FOOTER */
  .last-updated-bar { position: fixed; bottom: 0; right: 0; background: rgba(15,23,42,.85); color: #94a3b8; font-size: .65rem; padding: 4px 12px; border-radius: 8px 0 0 0; z-index: 90; backdrop-filter: blur(8px); }
  .last-updated-bar strong { color: #60a5fa; font-weight: 600; }

  /* AUTH OVERLAY */
  .auth-overlay { position:fixed; inset:0; background:#0f172a; display:flex; align-items:center; justify-content:center; z-index:9999; }
  .auth-overlay.hidden { display:none; }
  .auth-box { background:rgba(30,41,59,.85); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:3rem 2.5rem; text-align:center; max-width:400px; width:90%; }
  .auth-title { font-size:1.75rem; color:#fff; font-weight:700; }
  .auth-title span { color:#60a5fa; }
  .auth-sub { color:#94a3b8; font-size:.9rem; margin:.5rem 0 1.5rem; }
  .google-btn { display:inline-flex; align-items:center; gap:.6rem; background:#fff; border:none; border-radius:8px; padding:.7rem 1.5rem; font-size:.95rem; font-weight:600; cursor:pointer; font-family:inherit; }
  .google-btn:hover { background:#f1f5f9; }
  .auth-error { color:#ef4444; font-size:.85rem; margin-top:1rem; display:none; }
  .auth-domain { color:#64748b; font-size:.8rem; margin-top:1rem; }

  /* Toast */
  .toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%); background:#0f172a; color:#fff; padding:.75rem 1.5rem; border-radius:8px; font-size:.85rem; font-weight:500; z-index:300; opacity:0; transition:opacity .3s; pointer-events:none; }
  .toast.show { opacity:1; }
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
</head>
<body>

<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h1 class="auth-title">NF6 <span>Capital</span></h1>
    <p class="auth-sub">Compliance Calendar &mdash; Internal Use Only</p>
    <button class="google-btn" onclick="signInWithGoogle()">
      <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <div class="auth-error" id="authError"></div>
    <p class="auth-domain">Restricted to @nf6capital.com accounts</p>
  </div>
</div>

<nav>
  <a href="index.html" class="brand" style="text-decoration:none;color:#fff">NF6 <span>Capital</span></a>
  <div class="nav-links">
    <a href="index.html" data-i18n="nav_homebase">HomeBase</a>
    <a href="compliance-dashboard.html" data-i18n="nav_dashboard">Dashboard</a>
    <a href="compliance-calendar.html" class="active" data-i18n="nav_calendar">Calendar</a>
    <a href="audit-trail.html" data-i18n="nav_audit">Audit Trail</a>
    <a href="upload.html" data-i18n="nav_upload">Upload</a>
  </div>
  <div style="display:flex;align-items:center;gap:.4rem;">
    <button class="toggle-btn" onclick="toggleLang()" id="langToggle" title="Switch language"><span class="icon">&#127760;</span> <span class="label-text" id="langLabel">ES</span></button>
    <button class="toggle-btn" onclick="toggleTheme()" id="themeToggle" title="Toggle dark/light mode"><span class="icon" id="themeIcon">&#9789;</span> <span class="label-text" id="themeLabel">Dark</span></button>
    <div class="nav-clocks">
      <div class="nav-clock-circle"><span class="clock-label">COL</span><span class="clock-time" id="navClockCol">--:--</span></div>
      <div class="nav-clock-circle"><span class="clock-label">PR</span><span class="clock-time" id="navClockPR">--:--</span></div>
    </div>
    <div class="today-badge" id="todayBadge"></div>
  </div>
</nav>

<div class="mobile-menu" id="mm" style="display:none;position:fixed;top:56px;left:0;right:0;background:#0f172a;padding:.75rem;z-index:99;flex-direction:column;gap:.35rem">
  <a href="index.html" style="color:#94a3b8;text-decoration:none;padding:.6rem .75rem;border-radius:8px;font-size:.9rem" data-i18n="nav_homebase">HomeBase</a>
  <a href="compliance-dashboard.html" style="color:#94a3b8;text-decoration:none;padding:.6rem .75rem;border-radius:8px;font-size:.9rem" data-i18n="nav_dashboard">Dashboard</a>
  <a href="compliance-calendar.html" class="active" style="color:#fff;text-decoration:none;padding:.6rem .75rem;border-radius:8px;font-size:.9rem;background:#1e293b" data-i18n="nav_calendar">Calendar</a>
  <a href="audit-trail.html" style="color:#94a3b8;text-decoration:none;padding:.6rem .75rem;border-radius:8px;font-size:.9rem" data-i18n="nav_audit">Audit Trail</a>
  <a href="upload.html" style="color:#94a3b8;text-decoration:none;padding:.6rem .75rem;border-radius:8px;font-size:.9rem" data-i18n="nav_upload">Upload</a>
</div>

<div class="page-header">
  <h1>Compliance Calendar</h1>
  <p>Visual timeline of all upcoming compliance deadlines and due dates across all entities.</p>
</div>

<div class="main-layout">
  <!-- LEFT: Calendar -->
  <div class="calendar-col">
    <div class="cal-controls">
      <button id="prevBtn">&larr; Prev</button>
      <button class="today-btn" id="todayBtn">Today</button>
      <div class="month-label" id="monthLabel"></div>
      <button id="nextBtn">Next &rarr;</button>
    </div>
    <div class="filter-row">
      <select id="calLocFilter"><option value="all">All Locations</option></select>
      <select id="calEntFilter"><option value="all">All Entities</option></select>
      <select id="calPersonFilter"><option value="all">All People</option></select>
      <select id="calCatFilter"><option value="all">All Categories</option></select>
    </div>
    <div class="cal-grid">
      <div class="cal-header-row">
        <div class="day-label">Sun</div>
        <div class="day-label">Mon</div>
        <div class="day-label">Tue</div>
        <div class="day-label">Wed</div>
        <div class="day-label">Thu</div>
        <div class="day-label">Fri</div>
        <div class="day-label">Sat</div>
      </div>
      <div class="cal-body" id="calBody"></div>
    </div>
  </div>

  <!-- RIGHT: Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">&#128337; Live Clocks</div>
      <div class="live-clocks">
        <div class="clock-circle">
          <span class="clock-label">Colombia</span>
          <span class="clock-time" id="clockColombia">--:--:--</span>
        </div>
        <div class="clock-circle">
          <span class="clock-label">Puerto Rico</span>
          <span class="clock-time" id="clockPR">--:--:--</span>
        </div>
      </div>
    </div>
    <div class="sidebar-header" style="border-bottom: none; padding-bottom: 0;">
      <div class="sidebar-title" style="margin-bottom:0;">&#128203; Upcoming This Month <span id="upcomingCount" style="font-size:.75rem;font-weight:500;color:var(--text-secondary);margin-left:auto;"></span></div>
    </div>
    <div class="sidebar-body" id="upcomingList"></div>
    <div class="edit-panel" id="editPanel">
      <h3>
        <span id="editTitle">Edit Item</span>
        <button class="close-edit" onclick="closeEdit()">&times;</button>
      </h3>
      <div class="edit-field">
        <label>Status</label>
        <select id="editStatus">
          <option value="Recurring - Up to date">Up to Date</option>
          <option value="Recurring - Due Soon">Due Soon</option>
          <option value="Not started">Not Started</option>
        </select>
      </div>
      <div class="edit-field">
        <label>Next Due Date</label>
        <input type="date" id="editDueDate">
      </div>
      <div class="edit-field">
        <label>Assigned To</label>
        <input type="text" id="editPerson">
      </div>
      <div class="edit-field">
        <label>Notes</label>
        <input type="text" id="editNotes" placeholder="Add a note...">
      </div>
      <div class="edit-actions">
        <button class="btn-cancel" onclick="closeEdit()">Cancel</button>
        <button class="btn-save" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>
<div class="toast" id="toast"></div>
<div class="last-updated-bar" id="lastUpdated">Last updated: <strong>--</strong></div>

<script>
// == RAW DATA (same as dashboard) ==
const RAW_DATA = [
  {status:"Recurring - Up to date",type:"Property",category:"Property Taxes",location:"United States",entity:"NF Texas",obligation:"Pay property taxes by 1/31 each year — Harris County",person:"Amanda/Brandon",frequency:"Yearly",dateDone:"1/15/2026",dateToDo:"1/15/2027",nextDue:"1/31/2027",description:"Texas taxes SOP",cost:"",link:"https://myharriscountytax.com/"},
  {status:"Recurring - Up to date",type:"Property",category:"Property Taxes",location:"United States",entity:"NF Texas",obligation:"Pay property taxes by 1/31 each year — Spring Branch ISD",person:"Amanda/Brandon",frequency:"Yearly",dateDone:"1/15/2026",dateToDo:"1/15/2027",nextDue:"1/31/2027",description:"Texas taxes SOP",cost:"",link:"https://sbisd.propertytaxpayments.net/search"},
  {status:"Recurring - Up to date",type:"Donation",category:"Act 22 requirement",location:"Puerto Rico",entity:"MN Personal",obligation:"Make a yearly donation in PR",person:"Amanda/Brandon",frequency:"Yearly",dateDone:"1/8/2026",dateToDo:"1/5/2027",nextDue:"12/31/2027",description:"Donation SOP",cost:"$5,000.00",link:""},
  {status:"Recurring - Up to date",type:"529 Gift",category:"529 Gift",location:"United States",entity:"MN Personal",obligation:"Make yearly contribution to Dr. Mike's nieces and nephews",person:"Amanda/Brandon",frequency:"Yearly",dateDone:"12/29/2025",dateToDo:"12/1/2026",nextDue:"12/31/2026",description:"529 SOP",cost:"$114,000.00",link:"https://www.ugift529.com/"},
  {status:"Recurring - Up to date",type:"Car",category:"Tesla",location:"Puerto Rico",entity:"MN Personal",obligation:"Tesla Car Insurance",person:"Tim",frequency:"Yearly",dateDone:"10/6/2025",dateToDo:"9/1/2026",nextDue:"10/6/2026",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Car",category:"Tesla",location:"Puerto Rico",entity:"MN Personal",obligation:"Tesla Registration",person:"Tim",frequency:"Yearly",dateDone:"",dateToDo:"",nextDue:"",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Car",category:"Tahoe",location:"Colombia",entity:"NF MDE CO",obligation:"Tahoe insurance SURA",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"12/23/2025",dateToDo:"12/23/2026",nextDue:"12/28/2026",description:"",cost:"$3,842.00",link:""},
  {status:"Recurring - Up to date",type:"Car",category:"Tahoe",location:"Colombia",entity:"NF MDE CO",obligation:"Tahoe vehicle tax — Gobernación de Antioquia",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"1/15/2026",dateToDo:"1/15/2027",nextDue:"1/28/2027",description:"Pay through Gobernación de Ant. website",cost:"",link:"https://www.vehiculosantioquia.com.co/"},
  {status:"Recurring - Up to date",type:"Car",category:"Tahoe",location:"Colombia",entity:"NF MDE CO",obligation:"Tahoe — SOAT renewal",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"12/25/2025",dateToDo:"12/25/2026",nextDue:"12/25/2026",description:"Buy a new SOAT through Rappi or another website",cost:"",link:""},
  {status:"Recurring - Due Soon",type:"Insurance",category:"Dorado Insurance",location:"Puerto Rico",entity:"MN Personal",obligation:"Renew Insurance — hazard policy meets Oriental's requirements",person:"Tim",frequency:"Yearly",dateDone:"1/23/2026",dateToDo:"4/14/2026",nextDue:"5/14/2026",description:"MAPFRE Insurance",cost:"$2,667.00",link:""},
  {status:"Recurring - Up to date",type:"Insurance",category:"Dorado Insurance",location:"Puerto Rico",entity:"MN Personal",obligation:"Obtain Master Policy from Dorado — due to Oriental 60 days before expiry",person:"Tim",frequency:"Yearly",dateDone:"11/14/2025",dateToDo:"8/1/2026",nextDue:"11/14/2026",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Insurance",category:"Dorado Insurance",location:"Puerto Rico",entity:"MN Personal",obligation:"Commercial insurance",person:"Tim",frequency:"Yearly",dateDone:"2/17/2026",dateToDo:"1/16/2027",nextDue:"2/16/2027",description:"",cost:"$1,650.00",link:""},
  {status:"Recurring - Due Soon",type:"Property",category:"Maintenance",location:"Puerto Rico",entity:"MN Personal",obligation:"AC maintenance quarterly",person:"Amanda/Brandon",frequency:"Quarterly",dateDone:"2/3/2026",dateToDo:"5/1/2026",nextDue:"5/1/2026",description:"AC Maintenance Schedule",cost:"$295.00",link:""},
  {status:"Recurring - Due Soon",type:"Property",category:"Maintenance",location:"France",entity:"MN Personal",obligation:"AC maintenance bi-yearly",person:"Amanda/Brandon",frequency:"Bi-yearly",dateDone:"11/24/2025",dateToDo:"5/1/2026",nextDue:"5/24/2026",description:"AC Maintenance Schedule",cost:"$938.20",link:""},
  {status:"Recurring - Due Soon",type:"Property",category:"Maintenance",location:"Puerto Rico",entity:"MN Personal",obligation:"Exterminator monthly service",person:"Brandon",frequency:"Monthly",dateDone:"2/4/2026",dateToDo:"",nextDue:"3/2/2026",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Property",category:"Maintenance",location:"Puerto Rico",entity:"MN Personal",obligation:"Golf cart maintenance at Dorado",person:"Tim",frequency:"Monthly",dateDone:"",dateToDo:"",nextDue:"",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"MN Personal",category:"Passport",location:"United States",entity:"MN Personal",obligation:"Renew passport",person:"Mike/Amanda/Brandon",frequency:"Other",dateDone:"",dateToDo:"",nextDue:"3/25/2034",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"MN Personal",category:"Medical License",location:"Puerto Rico",entity:"MN Personal",obligation:"Renew Dr. Mike's medical license",person:"Mike",frequency:"Other",dateDone:"8/4/2024",dateToDo:"6/1/2027",nextDue:"8/4/2027",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"MN Personal",category:"PR Drivers License",location:"Puerto Rico",entity:"MN Personal",obligation:"Renew Dr. Mike's PR Drivers License",person:"Mike/Amanda/Brandon",frequency:"Other",dateDone:"6/20/2025",dateToDo:"5/1/2033",nextDue:"8/4/2033",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Business expense",category:"Keeper Security",location:"United States",entity:"TLMND",obligation:"Renew Keeper Security every 3 years",person:"Amanda/Brandon",frequency:"Other",dateDone:"6/24/2025",dateToDo:"5/1/2028",nextDue:"6/25/2028",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Entity",category:"Mailbox",location:"France",entity:"Paris Thacko",obligation:"Mailbox subscription — Paris (253 rue Saint Honoré)",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"7/16/2025",dateToDo:"7/1/2026",nextDue:"7/1/2026",description:"Pay through Banco Santander portal via transfer",cost:"$1,261.00",link:""},
  {status:"Recurring - Up to date",type:"Property",category:"House Insurance",location:"France",entity:"Paris Thacko",obligation:"House Insurance of 5 Quai Montebello — AXXA",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"12/5/2025",dateToDo:"12/1/2025",nextDue:"12/1/2026",description:"Pay through Banco Santander portal via transfer",cost:"$528.00",link:""},
  {status:"Recurring - Up to date",type:"Property",category:"Property Taxes",location:"France",entity:"Paris Thacko",obligation:"Tax Fonciere — RE Tax",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"10/27/2025",dateToDo:"10/1/2025",nextDue:"10/1/2026",description:"Automatic debit set up",cost:"$2,428.00",link:""},
  {status:"Recurring - Up to date",type:"Property",category:"Property Taxes",location:"France",entity:"Paris Thacko",obligation:"Vacant Housing Tax",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"12/30/2026",dateToDo:"10/31/2025",nextDue:"12/30/2026",description:"Automatic debit set up",cost:"$5,777.00",link:""},
  {status:"Recurring - Up to date",type:"Entity",category:"Entity Taxes",location:"France",entity:"Paris Thacko",obligation:"Paris Thacko corporate tax",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"10/1/2025",dateToDo:"10/1/2025",nextDue:"10/1/2026",description:"Automatic debit set up",cost:"",link:""},
  {status:"Recurring - Up to date",type:"Property",category:"HOA",location:"France",entity:"Paris Thacko",obligation:"5 Quai Montebello HOA — Syndic quarterly",person:"Manuela Vallejo",frequency:"Quarterly",dateDone:"12/28/2025",dateToDo:"4/1/2026",nextDue:"4/1/2026",description:"Pay through Banco Santander portal via transfer",cost:"$1,296.00",link:""},
  {status:"Recurring - Up to date",type:"Entity",category:"Accountant fees",location:"France",entity:"Paris Thacko",obligation:"Fees to France accountants Groupe Prieur (Dec & Mar)",person:"Manuela Vallejo",frequency:"Bi-yearly",dateDone:"12/9/2025",dateToDo:"3/10/2026",nextDue:"3/10/2026",description:"Pay through Banco Santander portal via transfer",cost:"$1,860.00",link:""},
  {status:"Recurring - Up to date",type:"Entity",category:"Tax returns filing",location:"France",entity:"Paris Thacko",obligation:"Tax returns filing — previous accounting year w/ Groupe Prieur",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"4/1/2025",dateToDo:"4/1/2025",nextDue:"4/1/2026",description:"",cost:"",link:""},
  {status:"Recurring - Up to date",type:"MN Personal",category:"Subscription",location:"United States",entity:"MN Personal",obligation:"United Club membership",person:"Mike/Amanda/Brandon",frequency:"Yearly",dateDone:"9/30/2025",dateToDo:"",nextDue:"9/30/2026",description:"Auto renew on TLMND business card",cost:"",link:""},
  {status:"Recurring - Up to date",type:"MN Personal",category:"Subscription",location:"United States",entity:"MN Personal",obligation:"AARP Membership renewal (every 5 years)",person:"Amanda/Brandon",frequency:"Other",dateDone:"2/3/2026",dateToDo:"2/1/2031",nextDue:"2/3/2031",description:"Go to website and click renew",cost:"$79.00",link:"https://secure.aarp.org/"},
  {status:"Recurring - Up to date",type:"MN Personal",category:"Health Insurance",location:"United States",entity:"MN Personal",obligation:"Renew Mike's Health Insurance — GeoBlue",person:"Tim",frequency:"Yearly",dateDone:"10/15/2025",dateToDo:"9/1/2026",nextDue:"10/14/2026",description:"",cost:"$762/month",link:""},
  {status:"Not started",type:"Property",category:"Real Estate Tax",location:"Colombia",entity:"NF MDE CO",obligation:"Quebrada Arriba RE Tax (Predial)",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"2/10/2025",dateToDo:"2/28/2026",nextDue:"2/28/2027",description:"Pay RE tax through Alcaldía de Med. portal",cost:"Variable",link:"https://www.medellin.gov.co"},
  {status:"Recurring - Up to date",type:"Property",category:"Real Estate Tax",location:"Colombia",entity:"NF MDE CO",obligation:"Cinturón Verde RE Tax (Predial)",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"2/10/2026",dateToDo:"2/10/2027",nextDue:"2/10/2027",description:"Pay RE tax through Alcaldía de Med. portal",cost:"Variable",link:"https://www.medellin.gov.co"},
  {status:"Recurring - Up to date",type:"Property",category:"Real Estate Tax",location:"Colombia",entity:"NF MDE CO",obligation:"Provincia Lot RE Tax (Predial)",person:"Manuela Vallejo",frequency:"Yearly",dateDone:"2/10/2026",dateToDo:"2/10/2027",nextDue:"",description:"Pay RE tax through Alcaldía de Med. portal",cost:"Variable",link:"https://www.medellin.gov.co"},
  {status:"Recurring - Up to date",type:"Insurance",category:"Life Insurance",location:"United States",entity:"MN Personal",obligation:"Renew Mike's life insurance — Lincoln Financial",person:"Tim",frequency:"Yearly",dateDone:"1/7/2026",dateToDo:"1/1/2027",nextDue:"1/7/2027",description:"",cost:"$1,609.58",link:"https://www.lincolnfinancial.com/secure/login"}
];

// == HELPERS ==
const TODAY = new Date();
TODAY.setHours(0,0,0,0);

function parseDate(str) {
  if (!str) return null;
  const parts = str.split('/');
  if (parts.length !== 3) return null;
  return new Date(+parts[2], +parts[0]-1, +parts[1]);
}

function daysUntil(dateStr) {
  const d = parseDate(dateStr);
  if (!d) return Infinity;
  return Math.ceil((d - TODAY) / (1000*60*60*24));
}

function formatDate(dateStr) {
  const d = parseDate(dateStr);
  if (!d) return '—';
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

function locationFlag(loc) {
  const map = { 'United States':'\ud83c\uddfa\ud83c\uddf8', 'Puerto Rico':'\ud83c\uddf5\ud83c\uddf7', 'Colombia':'\ud83c\udde8\ud83c\uddf4', 'France':'\ud83c\uddeb\ud83c\uddf7' };
  return map[loc] || '\ud83c\udf0d';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// == ENRICH DATA ==
let items = RAW_DATA.map(d => {
  const days = daysUntil(d.nextDue);
  let urgency = 'none';
  if (d.status === 'Not started') urgency = 'notstarted';
  else if (days < 0) urgency = 'overdue';
  else if (days <= 7) urgency = 'critical';
  else if (days <= 14) urgency = 'warning';
  else if (days <= 30) urgency = 'notice';
  return { ...d, _days: days, _urgency: urgency, _date: parseDate(d.nextDue) };
});

// == STATE ==
let viewYear = TODAY.getFullYear();
let viewMonth = TODAY.getMonth();
let editingIdx = -1;

// ── THEME + LANG ──
const TRANSLATIONS={en:{nav_homebase:'HomeBase',nav_dashboard:'Dashboard',nav_calendar:'Calendar',nav_audit:'Audit Trail',nav_upload:'Upload',nav_signout:'Sign Out'},es:{nav_homebase:'Inicio',nav_dashboard:'Panel',nav_calendar:'Calendario',nav_audit:'Historial',nav_upload:'Cargar',nav_signout:'Cerrar Sesión'}};
let currentLang=localStorage.getItem('nf6_lang')||'en';
let currentTheme=localStorage.getItem('nf6_theme')||'light';
function applyLang(lang){currentLang=lang;localStorage.setItem('nf6_lang',lang);document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(TRANSLATIONS[lang]&&TRANSLATIONS[lang][k])el.textContent=TRANSLATIONS[lang][k];});const next=lang==='en'?'ES':'EN';const lb=document.getElementById('langLabel');if(lb)lb.textContent=next;}
function toggleLang(){applyLang(currentLang==='en'?'es':'en');}
function applyTheme(theme){currentTheme=theme;localStorage.setItem('nf6_theme',theme);document.documentElement.setAttribute('data-theme',theme);const isDark=theme==='dark';const ti=document.getElementById('themeIcon');if(ti)ti.innerHTML=isDark?'&#9788;':'&#9789;';const tl=document.getElementById('themeLabel');if(tl)tl.textContent=isDark?'Light':'Dark';}
function toggleTheme(){applyTheme(currentTheme==='light'?'dark':'light');}
applyTheme(currentTheme);applyLang(currentLang);

// == LIVE CLOCKS ==
function updateClocks() {
  const now = new Date();
  const fmt = (tz) => now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
  const colTime = fmt('America/Bogota');
  const prTime = fmt('America/Puerto_Rico');
  const el1 = document.getElementById('clockColombia');
  const el2 = document.getElementById('clockPR');
  const el3 = document.getElementById('navClockCol');
  const el4 = document.getElementById('navClockPR');
  if (el1) el1.textContent = colTime;
  if (el2) el2.textContent = prTime;
  if (el3) el3.textContent = now.toLocaleTimeString('en-US', { timeZone: 'America/Bogota', hour: '2-digit', minute: '2-digit', hour12: true });
  if (el4) el4.textContent = now.toLocaleTimeString('en-US', { timeZone: 'America/Puerto_Rico', hour: '2-digit', minute: '2-digit', hour12: true });
}
setInterval(updateClocks, 1000);
updateClocks();

// == POPULATE FILTERS ==
function populateFilters() {
  const locs = [...new Set(items.map(i => i.location))].sort();
  const ents = [...new Set(items.map(i => i.entity))].sort();
  const ppl = [...new Set(items.flatMap(i => i.person.split('/')))].sort();
  const cats = [...new Set(items.map(i => i.category))].sort();

  const locSel = document.getElementById('calLocFilter');
  locs.forEach(l => { const o = document.createElement('option'); o.value=l; o.textContent=locationFlag(l)+' '+l; locSel.appendChild(o); });

  const entSel = document.getElementById('calEntFilter');
  ents.forEach(e => { const o = document.createElement('option'); o.value=e; o.textContent=e; entSel.appendChild(o); });

  const pSel = document.getElementById('calPersonFilter');
  ppl.forEach(p => { const o = document.createElement('option'); o.value=p; o.textContent=p; pSel.appendChild(o); });

  const catSel = document.getElementById('calCatFilter');
  cats.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
}

function getFilteredItems() {
  const locF = document.getElementById('calLocFilter').value;
  const entF = document.getElementById('calEntFilter').value;
  const pF = document.getElementById('calPersonFilter').value;
  const catF = document.getElementById('calCatFilter').value;
  return items.filter(i => {
    if (!i._date) return false;
    if (locF !== 'all' && i.location !== locF) return false;
    if (entF !== 'all' && i.entity !== entF) return false;
    if (pF !== 'all' && !i.person.includes(pF)) return false;
    if (catF !== 'all' && i.category !== catF) return false;
    return true;
  });
}

// == RENDER CALENDAR ==
function renderCalendar() {
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('monthLabel').textContent = monthNames[viewMonth] + ' ' + viewYear;

  const firstDay = new Date(viewYear, viewMonth, 1);
  const lastDay = new Date(viewYear, viewMonth + 1, 0);
  const startDow = firstDay.getDay();
  const daysInMonth = lastDay.getDate();

  const filtered = getFilteredItems();

  const dateMap = {};
  filtered.forEach(i => {
    if (!i._date) return;
    const key = i._date.getFullYear()+'-'+i._date.getMonth()+'-'+i._date.getDate();
    if (!dateMap[key]) dateMap[key] = [];
    dateMap[key].push(i);
  });

  const calBody = document.getElementById('calBody');
  let html = '';

  const prevLast = new Date(viewYear, viewMonth, 0).getDate();
  for (let i = startDow - 1; i >= 0; i--) {
    html += '<div class="cal-cell outside"><div class="date-num">'+(prevLast - i)+'</div></div>';
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const isToday = d === TODAY.getDate() && viewMonth === TODAY.getMonth() && viewYear === TODAY.getFullYear();
    const key = viewYear+'-'+viewMonth+'-'+d;
    const dayItems = dateMap[key] || [];
    const maxShow = 3;

    html += '<div class="cal-cell'+(isToday ? ' today' : '')+'">';
    html += '<div class="date-num">'+d+'</div>';
    dayItems.slice(0, maxShow).forEach(function(item) {
      const short = item.obligation.length > 28 ? item.obligation.substring(0,26) + '\u2026' : item.obligation;
      html += '<div class="cal-event urgency-'+item._urgency+'" data-idx="'+items.indexOf(item)+'">'+short+'</div>';
    });
    if (dayItems.length > maxShow) {
      html += '<div class="cal-more">+'+(dayItems.length - maxShow)+' more</div>';
    }
    html += '</div>';
  }

  const totalCells = startDow + daysInMonth;
  const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let i = 1; i <= remaining; i++) {
    html += '<div class="cal-cell outside"><div class="date-num">'+i+'</div></div>';
  }

  calBody.innerHTML = html;
  renderSidebar(filtered);
}

// == RENDER SIDEBAR ==
function renderSidebar(filtered) {
  const monthItems = filtered
    .filter(function(i) { return i._date && i._date.getMonth() === viewMonth && i._date.getFullYear() === viewYear; })
    .sort(function(a, b) { return a._date - b._date; });

  const container = document.getElementById('upcomingList');
  document.getElementById('upcomingCount').textContent = monthItems.length ? monthItems.length + ' items' : '';

  if (!monthItems.length) {
    container.innerHTML = '<div class="sidebar-empty">No compliance items due this month.</div>';
    return;
  }

  container.innerHTML = monthItems.map(function(i) {
    var idx = items.indexOf(i);
    var dotClass = i._urgency === 'notstarted' ? 'notstarted' : i._urgency === 'overdue' ? 'critical' : i._urgency;
    var dueLabel = i._days === 0 ? 'Due today' : i._days === 1 ? 'Due tomorrow' : i._days < 0 ? Math.abs(i._days)+' days overdue' : 'Due in '+i._days+' days';
    var dueColor = i._days <= 0 ? 'var(--red)' : i._days <= 7 ? 'var(--red)' : i._days <= 14 ? 'var(--orange)' : i._days <= 30 ? 'var(--yellow)' : 'var(--green)';
    return '<div class="sb-card" onclick="openEdit('+idx+')">' +
      '<div class="sb-edit-icon">\u270F\ufe0f Edit</div>' +
      '<div class="sb-top">' +
        '<div class="dot '+(dotClass || 'none')+'"></div>' +
        '<div class="sb-info">' +
          '<div class="sb-title">'+i.obligation+'</div>' +
          '<div class="sb-meta">'+i.entity+' \u00b7 '+locationFlag(i.location)+' '+i.location+' \u00b7 '+i.person+(i.cost ? ' \u00b7 '+i.cost : '')+'</div>' +
          '<div class="sb-due" style="color:'+dueColor+';">'+dueLabel+' \u2014 '+formatDate(i.nextDue)+'</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

// == EDIT ITEM ==
function openEdit(idx) {
  editingIdx = idx;
  var item = items[idx];
  document.getElementById('editTitle').textContent = item.obligation.length > 30 ? item.obligation.substring(0,28)+'\u2026' : item.obligation;
  document.getElementById('editStatus').value = item.status;
  document.getElementById('editPerson').value = item.person;
  document.getElementById('editNotes').value = item.description || '';

  // Convert M/D/YYYY to YYYY-MM-DD for date input
  if (item.nextDue) {
    var parts = item.nextDue.split('/');
    if (parts.length === 3) {
      document.getElementById('editDueDate').value = parts[2]+'-'+parts[0].padStart(2,'0')+'-'+parts[1].padStart(2,'0');
    }
  } else {
    document.getElementById('editDueDate').value = '';
  }

  document.getElementById('editPanel').classList.add('active');
}

function closeEdit() {
  editingIdx = -1;
  document.getElementById('editPanel').classList.remove('active');
}

function saveEdit() {
  if (editingIdx < 0) return;
  var item = items[editingIdx];
  var newStatus = document.getElementById('editStatus').value;
  var newDateVal = document.getElementById('editDueDate').value;
  var newPerson = document.getElementById('editPerson').value;
  var newNotes = document.getElementById('editNotes').value;

  // Convert YYYY-MM-DD back to M/D/YYYY
  var newDue = item.nextDue;
  if (newDateVal) {
    var dp = newDateVal.split('-');
    newDue = parseInt(dp[1])+'/'+parseInt(dp[2])+'/'+dp[0];
  }

  // Track changes for audit
  var changes = [];
  if (item.status !== newStatus) changes.push('Status: '+item.status+' -> '+newStatus);
  if (item.nextDue !== newDue) changes.push('Due: '+(item.nextDue||'none')+' -> '+newDue);
  if (item.person !== newPerson) changes.push('Person: '+item.person+' -> '+newPerson);
  if ((item.description||'') !== newNotes) changes.push('Notes updated');

  // Update item
  item.status = newStatus;
  item.nextDue = newDue;
  item.person = newPerson;
  item.description = newNotes;

  // Recalculate urgency
  item._days = daysUntil(newDue);
  item._date = parseDate(newDue);
  if (newStatus === 'Not started') item._urgency = 'notstarted';
  else if (item._days < 0) item._urgency = 'overdue';
  else if (item._days <= 7) item._urgency = 'critical';
  else if (item._days <= 14) item._urgency = 'warning';
  else if (item._days <= 30) item._urgency = 'notice';
  else item._urgency = 'none';

  // Log to shared audit (localStorage)
  if (changes.length) {
    var audit = [];
    try { audit = JSON.parse(localStorage.getItem('nf6_audit_log') || '[]'); } catch(e) {}
    var user = 'local';
    try { var u = firebase.auth().currentUser; if (u) user = u.email; } catch(e) {}
    audit.unshift({
      action: 'updated',
      obligation: item.obligation,
      user: user,
      timestamp: new Date().toISOString(),
      details: changes.join(' | ')
    });
    if (audit.length > 200) audit.length = 200;
    try { localStorage.setItem('nf6_audit_log', JSON.stringify(audit)); } catch(e) {}
  }

  closeEdit();
  renderCalendar();
  showToast(changes.length ? 'Item updated successfully' : 'No changes made');
}

// == TOOLTIP ==
document.getElementById('calBody').addEventListener('mouseover', function(e) {
  var ev = e.target.closest('.cal-event');
  if (!ev) return;
  var idx = +ev.dataset.idx;
  var item = items[idx];
  if (!item) return;

  var tt = document.getElementById('tooltip');
  var urgBadge = item._urgency === 'overdue' ? '<span class="badge badge-red">Overdue</span>'
    : item._urgency === 'notstarted' ? '<span class="badge badge-purple">Not Started</span>'
    : item._urgency === 'critical' ? '<span class="badge badge-red">Due \u2264 7d</span>'
    : item._urgency === 'warning' ? '<span class="badge badge-orange">Due \u2264 14d</span>'
    : item._urgency === 'notice' ? '<span class="badge badge-yellow">Due \u2264 30d</span>'
    : '<span class="badge badge-green">Up to Date</span>';

  tt.innerHTML =
    '<div class="tt-title">'+item.obligation+'</div>' +
    '<div class="tt-row"><div class="tt-label">Status</div><div class="tt-val">'+urgBadge+'</div></div>' +
    '<div class="tt-row"><div class="tt-label">Entity</div><div class="tt-val">'+item.entity+'</div></div>' +
    '<div class="tt-row"><div class="tt-label">Location</div><div class="tt-val">'+locationFlag(item.location)+' '+item.location+'</div></div>' +
    '<div class="tt-row"><div class="tt-label">Person</div><div class="tt-val">'+item.person+'</div></div>' +
    '<div class="tt-row"><div class="tt-label">Category</div><div class="tt-val"><span class="badge badge-blue">'+item.category+'</span></div></div>' +
    '<div class="tt-row"><div class="tt-label">Due</div><div class="tt-val">'+formatDate(item.nextDue)+'</div></div>' +
    (item.cost ? '<div class="tt-row"><div class="tt-label">Cost</div><div class="tt-val">'+item.cost+'</div></div>' : '') +
    (item.description ? '<div class="tt-row"><div class="tt-label">Notes</div><div class="tt-val">'+item.description+'</div></div>' : '');

  var rect = ev.getBoundingClientRect();
  tt.style.left = Math.min(rect.right + 8, window.innerWidth - 340) + 'px';
  tt.style.top = Math.max(rect.top - 20, 10) + 'px';
  tt.classList.add('show');
});

document.getElementById('calBody').addEventListener('mouseout', function(e) {
  var ev = e.target.closest('.cal-event');
  if (!ev) return;
  document.getElementById('tooltip').classList.remove('show');
});

// == EVENT LISTENERS ==
document.getElementById('todayBadge').textContent = TODAY.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });

document.getElementById('prevBtn').addEventListener('click', function() {
  viewMonth--;
  if (viewMonth < 0) { viewMonth = 11; viewYear--; }
  closeEdit();
  renderCalendar();
});
document.getElementById('nextBtn').addEventListener('click', function() {
  viewMonth++;
  if (viewMonth > 11) { viewMonth = 0; viewYear++; }
  closeEdit();
  renderCalendar();
});
document.getElementById('todayBtn').addEventListener('click', function() {
  viewYear = TODAY.getFullYear();
  viewMonth = TODAY.getMonth();
  closeEdit();
  renderCalendar();
});

document.getElementById('calLocFilter').addEventListener('change', renderCalendar);
document.getElementById('calEntFilter').addEventListener('change', renderCalendar);
document.getElementById('calPersonFilter').addEventListener('change', renderCalendar);
document.getElementById('calCatFilter').addEventListener('change', renderCalendar);

// == AUTH ==
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAbvvj4qCzfZPdRxU6BtbRSfXDXPitNwkQ",
  authDomain: "nf6-compliance.firebaseapp.com",
  projectId: "nf6-compliance",
  storageBucket: "nf6-compliance.firebasestorage.app",
  messagingSenderId: "758076256010",
  appId: "1:758076256010:web:5799632950c369244c54f3"
};
const ALLOWED_DOMAIN = 'nf6capital.com';
const AUTH_ENABLED = true;

function initAuth() {
  if (!AUTH_ENABLED) { document.getElementById('authOverlay').classList.add('hidden'); return; }
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        if (user.email.split('@')[1] === ALLOWED_DOMAIN) {
          document.getElementById('authOverlay').classList.add('hidden');
        } else {
          showAuthError('Access restricted to @' + ALLOWED_DOMAIN); firebase.auth().signOut();
        }
      } else { document.getElementById('authOverlay').classList.remove('hidden'); }
    });
  } catch(e) { console.warn('Firebase:', e.message); document.getElementById('authOverlay').classList.add('hidden'); }
}
function signInWithGoogle() {
  if (!AUTH_ENABLED) return;
  var p = new firebase.auth.GoogleAuthProvider(); p.setCustomParameters({hd: ALLOWED_DOMAIN});
  firebase.auth().signInWithPopup(p).catch(function(e) { showAuthError(e.message); });
}
function showAuthError(msg) { var e = document.getElementById('authError'); e.textContent = msg; e.style.display = 'block'; }

// == LAST UPDATED ==
function updateLastUpdated() {
  const el = document.getElementById('lastUpdated');
  if (!el) return;
  const now = new Date();
  el.innerHTML = 'Last updated: <strong>' + now.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) + '</strong>';
}
updateLastUpdated();
setInterval(updateLastUpdated, 60000);

// == INIT ==
initAuth();
populateFilters();
renderCalendar();
</script>
</body>
</html>
